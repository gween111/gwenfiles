<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GWEN PLANNER - Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GwenPlanner">  

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="manifest" href="./manifest.json?v=1">
    <link rel="apple-touch-icon" href="./icon192.png?v=1">
    <style>
        /* ÁP DỤNG FONT MỚI */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .tkb-cell { min-height: 60px; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 11px; padding: 2px; cursor: pointer; transition: all 0.2s; }
        .tkb-cell:hover { background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"; 
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        // --- CHỈ GIỮ 1 BẢN CONFIG DUY NHẤT Ở ĐÂY ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKIuhkP1A_RRb6m45vz6KqIR2aFYMKLKA",
            authDomain: "gwen1stproject.firebaseapp.com",
            projectId: "gwen1stproject",
            storageBucket: "gwen1stproject.firebasestorage.app",
            messagingSenderId: "761090626102",
            appId: "1:761090626102:web:3b03bd38c4e33495a83e97",
            measurementId: "G-4WCFDLC7F4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.LOGIN_GOOGLE = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert(e.message); } };
        window.LOGOUT = () => signOut(auth);
        window.AUTH_SUBSCRIBE = (callback) => onAuthStateChanged(auth, callback);
        
        // Cung cấp công cụ cho React
        window.DB_TOOLS = { db, doc, setDoc, updateDoc, onSnapshot, getDoc, collection };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICON ---
        const Icon = ({ p, size=24, className="" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={p}/></svg>
        );
        const icons = {
            grad: "M22 10v6M2 10l10-5 10 5-10 5z M6 12v5c3 3 9 3 12 0v-5",
            check: "M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4 12 14.01 9 11.01",
            clock: "M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M12 6v6l4 2",
            book: "M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",
            down: "M6 9l6 6 6-6", right: "M9 18l6-6-9-6",
            trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
            plus: "M12 5v14 M5 12h14", x: "M18 6L6 18 M6 6l12 12",
            cal: "M3 4h18v18H3z M16 2v4 M8 2v4 M3 10h18",
            act: "M22 12h-4l-3 9L9 3l-3 9H2", vid: "M23 7l-7 5 7 5V7z M14 5H3v14h11V5z",
            eng: "M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",
            list: "M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01",
            grid: "M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z",
            left: "M15 18l-6-6 6-6",
            right: "M9 18l6-6-6-6",
            atom: "M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0 M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9S4.1 3.05 2 5.1c-2.04 2.03-.02 7.36 4.5 11.9s11.6 5.25 13.7 3.2z M2 20.2c-2.04-2.03-.02-7.36 4.5-11.9S18.1 3.05 20.2 5.1c2.04 2.03.02 7.36-4.5 11.9s-11.6 5.25-13.7 3.2z",
            settings: "M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z",
            dna: "M2 15c6.667-6 13.333 0 20-6 M9 22c1.798-1.998 2.518-3.995 2.807-5.993 M15 2c-1.798 1.998-2.518 3.995-2.807 5.993 M17 12a5 5 0 1 1-10 0 5 5 0 0 1 10 0z"
        };
        const I = ({ n, ...p }) => <Icon p={icons[n]} {...p} />;

        // --- 1. DỮ LIỆU MẶC ĐỊNH: VẬT LÝ (Dùng cho mọi email khác) ---
        const DATA_VAT_LY = [
            { id: 'general_excluded', title: 'GDTC & QP-AN (Không tính CPA)', requiredCredits: 15, courses: [ { code: 'CME1000', name: 'Giáo dục Quốc phòng - An ninh', credits: 8, required: true }, { code: 'PES1000', name: 'Giáo dục thể chất', credits: 4, required: true }, { code: 'HUS1012', name: 'Kỹ năng bổ trợ', credits: 3, required: true }, ] },
            { id: 'general', title: 'I. Khối kiến thức chung', requiredCredits: 21, courses: [ { code: 'PHI1006', name: 'Triết học Mác - Lênin', credits: 3, required: true }, { code: 'PEC1008', name: 'Kinh tế chính trị Mác - Lênin', credits: 2, required: true }, { code: 'PHI1002', name: 'CNXH khoa học', credits: 2, required: true }, { code: 'HIS1001', name: 'Lịch sử Đảng CSVN', credits: 2, required: true }, { code: 'POL1001', name: 'Tư tưởng Hồ Chí Minh', credits: 2, required: true }, { code: 'THL1057', name: 'Nhà nước và pháp luật đại cương', credits: 2, required: true }, { code: 'VNU1001', name: 'Công nghệ số và AI', credits: 3, required: true }, { code: 'FLFxxxx', name: 'Ngoại ngữ B1', credits: 5, required: true }, ] },
            { id: 'field', title: 'II. Khối kiến thức theo lĩnh vực', requiredCredits: 5, courses: [ { code: 'HUS1021', name: 'KH trái đất và sự sống', credits: 3, required: false }, { code: 'HUS1022', name: 'Nhập môn IoT', credits: 2, required: false }, { code: 'HUS1023', name: 'Phân tích dữ liệu', credits: 2, required: false }, { code: 'HUS1024', name: 'Nhập môn Robotics', credits: 3, required: false }, { code: 'HIS1056', name: 'Cơ sở văn hóa VN', credits: 3, required: false }, ] },
            { id: 'block_compulsory', title: 'III.1. Khối ngành (Bắt buộc)', requiredCredits: 12, courses: [ { code: 'PHY1106', name: 'Đại số tuyến tính', credits: 3, required: true }, { code: 'PHY1107', name: 'Giải tích 1', credits: 3, required: true }, { code: 'PHY1108', name: 'Giải tích 2', credits: 3, required: true }, { code: 'PHY1109', name: 'Xác suất thống kê', credits: 3, required: true }, ] },
            { id: 'block_elective', title: 'III.2. Khối ngành (Tự chọn)', requiredCredits: 3, courses: [ { code: 'CHE1080', name: 'Hóa học đại cương', credits: 3, required: false }, { code: 'PHY1112', name: 'Vật lý môi trường', credits: 3, required: false }, { code: 'PHY1303', name: 'Lập trình Python', credits: 3, required: false }, { code: 'PHY1113', name: 'Lập trình C', credits: 3, required: false }, { code: 'PHY1114', name: 'Lập trình Matlab', credits: 3, required: false }, ] },
            { id: 'group_compulsory', title: 'IV.1. Nhóm ngành (Bắt buộc)', requiredCredits: 29, courses: [ { code: 'PHY1348', name: 'Phương pháp toán cho VL', credits: 3, required: true }, { code: 'PHY1050', name: 'Cơ học', credits: 3, required: true }, { code: 'PHY2302', name: 'Nhiệt động học & VLPT', credits: 3, required: true }, { code: 'PHY1314', name: 'Điện và từ học', credits: 3, required: true }, { code: 'PHY2304', name: 'Quang học', credits: 3, required: true }, { code: 'PHY1341', name: 'KH vật liệu đại cương', credits: 3, required: true }, { code: 'PHY2307', name: 'Thực hành VLĐC 1', credits: 2, required: true }, { code: 'PHY2308', name: 'Thực hành VLĐC 2', credits: 2, required: true }, { code: 'PHY2309', name: 'Thực hành VLĐC 3', credits: 2, required: true }, { code: 'PHY3503', name: 'Tiếng Anh chuyên ngành', credits: 2, required: true }, { code: 'PHY2206', name: 'Kỹ thuật điện tử', credits: 3, required: true }, ] },
            { id: 'group_elective', title: 'IV.2. Nhóm ngành (Tự chọn)', requiredCredits: 3, courses: [ { code: 'PHY3296', name: 'Tiểu luận', credits: 3, required: false }, { code: 'PHY1345', name: 'Kỹ thuật phân tích phổ', credits: 3, required: false }, { code: 'PHY3302', name: 'Điện động lực học', credits: 3, required: false }, { code: 'PHY2000', name: 'Phương pháp NCKH', credits: 3, required: false }, { code: 'PHY3301', name: 'Cơ học lý thuyết', credits: 3, required: false }, ] },
            { id: 'major_compulsory', title: 'V.1. Kiến thức ngành (Bắt buộc)', requiredCredits: 35, courses: [ { code: 'PHY1440', name: 'Hoá học Vật liệu', credits: 3, required: true }, { code: 'PHY2064', name: 'Vật lý nguyên tử', credits: 2, required: true }, { code: 'PHY1441', name: 'Spintronics và ứng dụng', credits: 3, required: true }, { code: 'PHY1310', name: 'Vật lý bán dẫn', credits: 3, required: true }, { code: 'PHY3169', name: 'Cơ học lượng tử', credits: 3, required: true }, { code: 'PHY3303', name: 'Vật lý thống kê', credits: 3, required: true }, { code: 'PHY3700', name: 'PP thực nghiệm trong KHVL', credits: 3, required: true }, { code: 'PHY3346', name: 'Vật lý chất rắn', credits: 3, required: true }, { code: 'PHY3702', name: 'Cấu trúc thấp chiều & Nano', credits: 3, required: true }, { code: 'PHY3712', name: 'Vật liệu & CN bán dẫn', credits: 3, required: true }, { code: 'PHY3454', name: 'Thực tập thực tế', credits: 3, required: true }, { code: 'PHY3437', name: 'Kỹ thuật đo lường & Xử lý TH', credits: 3, required: true }, ] },
            { id: 'major_elective', title: 'V.2. Kiến thức ngành (Tự chọn)', requiredCredits: 18, courses: [ { code: 'PHY1340', name: 'CN màng mỏng', credits: 3, required: false }, { code: 'PHY1332', name: 'Thiết kế vi mạch CMOS VLSI', credits: 3, required: false }, { code: 'PHY3351', name: 'Vật lý linh kiện bán dẫn', credits: 3, required: false }, { code: 'PHY1442', name: 'Mở đầu CN đóng gói bán dẫn', credits: 3, required: false }, { code: 'PHY1443', name: 'Mở đầu CN kiểm thử bán dẫn', credits: 3, required: false }, { code: 'PHY1444', name: 'Thực tập chuyên ngành', credits: 3, required: false }, { code: 'PHY1445', name: 'Giới thiệu thiết bị SX bán dẫn', credits: 3, required: false }, { code: 'PHY3465', name: 'Cảm biến và ứng dụng', credits: 3, required: false }, { code: 'PHY3722', name: 'Linh kiện chuyển đổi năng lượng', credits: 3, required: false }, { code: 'PHY3648', name: 'Thiết kế mạch điện tử', credits: 3, required: false }, { code: 'PHY1338', name: 'CN chế tạo vi mạch tích hợp', credits: 3, required: false }, { code: 'PHY3713', name: 'Quang điện tử và quang tử', credits: 3, required: false }, { code: 'PHY3650', name: 'Xử lý tín hiệu số', credits: 3, required: false }, { code: 'PHY3335', name: 'Hệ thống nhúng', credits: 3, required: false }, ] },
            { id: 'thesis', title: 'V.3. Khóa luận tốt nghiệp', requiredCredits: 7, courses: [ { code: 'PHY4090', name: 'Khóa luận tốt nghiệp', credits: 7, required: false }, { code: 'PHY1363', name: 'Vật lý hiện đại', credits: 4, required: false }, { code: 'PHY1358', name: 'VL micro và nano', credits: 3, required: false }, ] }
        ];

        // --- 2. DỮ LIỆU CÔNG NGHỆ SINH HỌC --
        const DATA_CNSH = [
            { id: 'general_excluded', title: 'GDTC & QP-AN (Không tính CPA)', requiredCredits: 15, courses: [ { code: 'CME1000', name: 'Giáo dục Quốc phòng - An ninh', credits: 8, required: true }, { code: 'PES1000', name: 'Giáo dục thể chất', credits: 4, required: true }, { code: 'HUS1012', name: 'Kỹ năng bổ trợ', credits: 3, required: true }, ] },
            { id: 'general', title: 'I. Khối kiến thức chung', requiredCredits: 21, courses: [ { code: 'PHI1006', name: 'Triết học Mác - Lênin', credits: 3, required: true }, { code: 'PEC1008', name: 'Kinh tế chính trị Mác - Lênin', credits: 2, required: true }, { code: 'PHI1002', name: 'CNXH khoa học', credits: 2, required: true }, { code: 'HIS1001', name: 'Lịch sử Đảng CSVN', credits: 2, required: true }, { code: 'POL1001', name: 'Tư tưởng Hồ Chí Minh', credits: 2, required: true }, { code: 'THL1057', name: 'Nhà nước và pháp luật đại cương', credits: 2, required: true }, { code: 'VNU1001', name: 'Công nghệ số và AI', credits: 3, required: true }, { code: 'FLFxxxx', name: 'Ngoại ngữ B1', credits: 5, required: true }, ] },
            { id: 'field', title: 'II. Khối kiến thức theo lĩnh vực', requiredCredits: 5, courses: [ { code: 'HUS1021', name: 'KH trái đất và sự sống', credits: 3, required: false }, { code: 'HUS1022', name: 'Nhập môn IoT', credits: 2, required: false }, { code: 'HUS1023', name: 'Phân tích dữ liệu', credits: 2, required: false }, { code: 'HUS1024', name: 'Nhập môn Robotics', credits: 3, required: false }, { code: 'HIS1056', name: 'Cơ sở văn hóa VN', credits: 3, required: false }, ] },
            { id: 'block_compulsory', title: 'III.1. Khối ngành (Bắt buộc)', requiredCredits: 18, courses: [ { code: 'MAT1101', name: 'Xác suất thống kê', credits: 3, required: true }, { code: 'PHY1159', name: 'Vật lý đại cương 1', credits: 3, required: true }, { code: 'CHE1080', name: 'Hoá học đại cương', credits: 3, required: true }, { code: 'CHE1081', name: 'Hoá học hữu cơ', credits: 3, required: true }, { code: 'CHE1057', name: 'Hoá học phân tích', credits: 3, required: true }, { code: 'CHE1173', name: 'Hoá lý', credits: 3, required: true }, ] },
            { id: 'block_elective', title: 'III.2. Khối ngành (Tự chọn)', requiredCredits: 4, courses: [ { code: 'CHE1069', name: 'Thực tập hoá học đại cương', credits: 2, required: false }, { code: 'CHE1020', name: 'Thực tập Hoá học hữu cơ', credits: 2, required: false }, { code: 'CHE1021', name: 'Thực tập hoá học phân tích', credits: 2, required: false }, { code: 'PHY1104', name: 'Thực hành vật lý đại cương', credits: 2, required: false }, ] },
            { id: 'group_compulsory', title: 'IV.1. Nhóm ngành (Bắt buộc)', requiredCredits: 32, courses: [ { code: 'BIO1206', name: 'Sinh học tế bào', credits: 2, required: true }, { code: 'BIO1163', name: 'Hoá sinh học', credits: 2, required: true }, { code: 'BIO2047', name: 'Di truyền học', credits: 2, required: true }, { code: 'BIO1201', name: 'Sinh học phân tử', credits: 2, required: true }, { code: 'BIO1241', name: 'Vi sinh vật học', credits: 3, required: true }, { code: 'BIO1203', name: 'Sinh học phát triển', credits: 2, required: true }, { code: 'BIO1187', name: 'PP luận trong NCKH sự sống', credits: 3, required: true }, { code: 'BIO1213', name: 'Sinh lý học người và động vật', credits: 3, required: true }, { code: 'BIO1224', name: 'Thực hành Sinh học thực nghiệm 1', credits: 2, required: true }, { code: 'BIO1225', name: 'Thực hành Sinh học thực nghiệm 2', credits: 2, required: true }, { code: 'BIO1231', name: 'Thực vật và ứng dụng', credits: 2, required: true }, { code: 'BIO1158', name: 'ĐV không xương sống & ứng dụng', credits: 2, required: true }, { code: 'BIO1210', name: 'Sinh học ứng dụng & bảo tồn ĐV', credits: 2, required: true }, { code: 'BIO1220', name: 'Sinh thái học', credits: 2, required: true }, { code: 'BIO1223', name: 'Thực hành Đa dạng sinh học', credits: 2, required: true }, ] },
            { id: 'group_elective', title: 'IV.2. Nhóm ngành (Tự chọn)', requiredCredits: 15, courses: [ { code: 'BIO1175', name: 'Lý sinh học', credits: 3, required: false }, { code: 'BIO1190', name: 'Proteomic và sinh học cấu trúc', credits: 3, required: false }, { code: 'BIO1178', name: 'Miễn dịch học', credits: 3, required: false }, { code: 'BIO1243', name: 'Virus học cơ sở', credits: 3, required: false }, { code: 'BIO3252', name: 'Sinh học người', credits: 3, required: false }, { code: 'BIO1209', name: 'Sinh học tiến hoá', credits: 3, required: false }, { code: 'BIO1120E', name: 'Tiếng Anh chuyên ngành Sinh học', credits: 2, required: false }, { code: 'BIO2130', name: 'Thống kê sinh học', credits: 2, required: false }, { code: 'BIO1165', name: 'Thực tập thiên nhiên', credits: 2, required: false }, { code: 'BIO1130', name: 'Các nguyên lý của sinh học bảo tồn', credits: 2, required: false }, { code: 'BIO1170', name: 'Ký sinh trùng đại cương', credits: 2, required: false }, { code: 'BIO1193', name: 'QL các khu bảo tồn thiên nhiên', credits: 2, required: false }, ] },
            { id: 'major_compulsory', title: 'V.1. Kiến thức ngành (Bắt buộc)', requiredCredits: 18, courses: [ { code: 'BIO3702', name: 'Quá trình và thiết bị công nghệ', credits: 3, required: true }, { code: 'BIO1233', name: 'Tin sinh học', credits: 3, required: true }, { code: 'BIO1238', name: 'Vi sinh vật học ứng dụng', credits: 3, required: true }, { code: 'BIO1195', name: 'Sinh học chức năng thực vật', credits: 3, required: true }, { code: 'BIO1173', name: 'Kỹ thuật di truyền', credits: 3, required: true }, { code: 'BIO1226', name: 'Thực tập thực tế CN Sinh học', credits: 3, required: true }, ] },
            { id: 'major_elective', title: 'V.2. Kiến thức ngành (Tự chọn)', requiredCredits: 12, courses: [ { code: 'BIO1248', name: 'Di truyền học vi sinh vật', credits: 3, required: false }, { code: 'BIO1149', name: 'Di truyền học ung thư', credits: 3, required: false }, { code: 'BIO1137', name: 'Công nghệ sinh học dược phẩm', credits: 3, required: false }, { code: 'BIO1105E', name: 'Công nghệ protein-enzym', credits: 3, required: false }, { code: 'BIO1244', name: 'Di truyền y học', credits: 3, required: false }, { code: 'BIO1239', name: 'VSV học và xử lý môi trường', credits: 3, required: false }, { code: 'BIO1101E', name: 'Các nguyên lý cải biến di truyền VSV', credits: 3, required: false }, { code: 'BIO1237', name: 'Vi sinh vật học thực phẩm', credits: 3, required: false }, { code: 'BIO1131', name: 'Cơ sở công nghệ lên men', credits: 3, required: false }, { code: 'BIO1162', name: 'Hoá sinh học chế biến thực phẩm', credits: 3, required: false }, { code: 'BIO1161', name: 'Hoá sinh học các hợp chất hoạt tính', credits: 3, required: false }, { code: 'BIO1119E', name: 'Sinh vật biến đổi gen và ứng dụng', credits: 3, required: false }, { code: 'BIO1104E', name: 'Công nghệ mô và tế bào thực vật', credits: 3, required: false }, { code: 'BIO1136', name: 'Công nghệ mô và tế bào động vật', credits: 3, required: false }, { code: 'BIO1142', name: 'Công nghệ tế bào gốc', credits: 3, required: false }, { code: 'BIO1197', name: 'Sinh học khối u', credits: 3, required: false }, { code: 'BIO1132', name: 'Cơ sở phân tử của bệnh', credits: 3, required: false }, { code: 'BIO1208', name: 'Sinh học thần kinh', credits: 3, required: false }, { code: 'BIO1110E', name: 'Nội tiết học', credits: 3, required: false }, { code: 'BIO1115E', name: 'Sinh học phân tử người', credits: 3, required: false }, { code: 'BIO1127', name: 'Bệnh học miễn dịch và trị liệu', credits: 3, required: false }, { code: 'BIO1117E', name: 'Sinh lý tuần hoàn', credits: 3, required: false }, { code: 'BIO1144', name: 'Công nghệ vi tảo', credits: 3, required: false }, { code: 'BIO1140', name: 'CN Sinh học trong bảo vệ thực vật', credits: 3, required: false }, { code: 'BIO1139', name: 'CN SH trong bảo tồn thực vật', credits: 3, required: false }, { code: 'BIO1102E', name: 'Cây thuốc và Dược liệu', credits: 3, required: false }, { code: 'BIO1141', name: 'Công nghệ tảo và nấm', credits: 3, required: false }, { code: 'BIO1108E', name: 'Độc tố tự nhiên và ứng dụng', credits: 3, required: false }, { code: 'BIO3186', name: 'Động vật dược liệu', credits: 3, required: false }, { code: 'BIO1103E', name: 'Côn trùng học', credits: 3, required: false }, { code: 'BIO1221', name: 'Tập tính học động vật', credits: 3, required: false }, { code: 'BIO1159', name: 'Động vật y học', credits: 3, required: false }, { code: 'BIO1219', name: 'Sinh thái học ứng dụng', credits: 3, required: false }, { code: 'BIO1182', name: 'Môi trường và phát triển bền vững', credits: 3, required: false }, { code: 'BIO1118E', name: 'Sinh thái học môi trường', credits: 3, required: false }, ] },
            { id: 'thesis', title: 'V.3. Khóa luận tốt nghiệp', requiredCredits: 7, courses: [ { code: 'BIO4073', name: 'Khóa luận tốt nghiệp', credits: 7, required: false }, { code: 'BIO1247', name: 'Dấu chuẩn di truyền và nhận dạng cá thể (Thay thế)', credits: 2, required: false }, { code: 'BIO3177', name: 'Năng lượng sinh học (Thay thế)', credits: 2, required: false }, ] }
        ];

        // --- 3. CÁC COMPONENT GIAO DIỆN ---
        const UserHeader = ({ user, isAdmin, currentMajor, setCurrentMajor }) => {
            return (
                <div className="bg-white/80 backdrop-blur-md border-b border-slate-100 sticky top-0 z-30 shadow-sm transition-all">
                    <div className="flex justify-between items-center p-4">
                        <div className="flex items-center gap-3">
                            {user ? (
                                <>
                                    <div className="relative">
                                        <img src={user.photoURL} className="w-9 h-9 rounded-full border border-slate-200 shadow-sm" />
                                        <div className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-emerald-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div className="flex flex-col">
                                        <span className="text-xs font-bold text-slate-800">{user.displayName}</span>
                                        <span className="text-[10px] font-medium text-slate-500 uppercase tracking-wide">{isAdmin ? "Admin" : "Member"}</span>
                                    </div>
                                </>
                            ) : <span className="text-sm font-medium text-slate-400">Chưa đăng nhập</span>}
                        </div>
                        <div className="flex items-center gap-3">
                            {isAdmin && user && (
                                <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                                    <button onClick={() => setCurrentMajor('vat_ly')} className={`p-2 rounded-md transition-all ${currentMajor === 'vat_ly' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`}>
                                        <I n="atom" size={18}/>
                                    </button>
                                    <button onClick={() => setCurrentMajor('cnsh')} className={`p-2 rounded-md transition-all ${currentMajor === 'cnsh' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>
                                        <I n="dna" size={18}/>
                                    </button>
                                </div>
                            )}
                            {user ? (
                                <button onClick={() => window.LOGOUT()} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all"><I n="x" size={24}/></button>
                            ) : (
                                <button onClick={() => window.LOGIN_GOOGLE()} className="bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md hover:scale-105 transition-transform">Đăng nhập</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const PlaceholderView = ({title, icon}) => (
            <div className="flex flex-col items-center justify-center h-[60vh] text-gray-400">
                <div className="mb-4 bg-slate-100 p-6 rounded-full"><I n={icon} size={48}/></div>
                <h3 className="font-bold text-lg text-slate-600">{title}</h3>
                <p className="text-sm">Tính năng đang được phát triển...</p>
            </div>
        );

        // --- COMPONENT: DASHBOARD & CPA (CẬP NHẬT NHẬN DỮ LIỆU ĐỘNG) ---
        const TrackerView = ({ courseData = DATA_VAT_LY, statusMap, updateStatusMap, scoreMap, updateScoreMap, isReadOnly }) => {
            // Dùng courseData được truyền vào thay vì biến cứng
            const dataToUse = courseData || DATA_VAT_LY; 
            
            const [expandedSections, setExpandedSections] = useState(dataToUse.map(s => s.id));
            const toggleSection = (id) => setExpandedSections(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            
            // Khi đổi tài khoản (đổi ngành), reset lại danh sách mở rộng theo ngành mới
            useEffect(() => {
                setExpandedSections(dataToUse.map(s => s.id));
            }, [dataToUse]);

            const handleStatus = (code, status) => {
                if(isReadOnly) return;
                const next = {...statusMap};
                statusMap[code] === status ? delete next[code] : next[code] = status;
                updateStatusMap(next);
            };

            const handleScore = (code, val) => {
                if(isReadOnly) return;
                const next = {...scoreMap};
                val === '' ? delete next[code] : next[code] = parseFloat(val);
                updateScoreMap(next);
            };

            // LOGIC TÍNH TOÁN (Dùng dataToUse)
            const stats = useMemo(() => {
                let studiedCredits = 0, totalScorePoints = 0, gpaCredits = 0;
                
                // Duyệt qua dữ liệu động (dataToUse) thay vì COURSE_DATA
                dataToUse.forEach(s => { 
                    if (s.id === 'general_excluded') return; 
                    s.courses.forEach(c => {
                        if (statusMap[c.code] === 'studied') {
                            studiedCredits += c.credits;
                            const sc = scoreMap ? scoreMap[c.code] : undefined;
                            if (sc !== undefined && !isNaN(sc)) {
                                totalScorePoints += sc * c.credits;
                                gpaCredits += c.credits;
                            }
                        }
                    });
                });

                const cpa = gpaCredits > 0 ? (totalScorePoints / gpaCredits).toFixed(2) : "0.00";
                
                // Tính tổng tín chỉ mục tiêu của ngành hiện tại
                const totalTarget = dataToUse.reduce((acc, sec) => acc + (sec.id === 'general_excluded' ? 0 : sec.requiredCredits), 0);

                return { studiedCredits, cpa, totalTarget };
            }, [statusMap, scoreMap, dataToUse]);

            return (
                <div className="pb-24 p-4 md:p-8 max-w-7xl mx-auto font-sans">
                    {/* Header */}
                    <div className="mb-8">
                        <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight mb-2">Tổng quan học tập</h1>
                        <p className="text-slate-500">Quản lý tiến độ và điểm trung bình tích lũy (CPA)</p>
                    </div>

                    {/* Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div className="bg-white p-6 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 relative overflow-hidden">
                            <div className="flex items-center gap-4 relative z-10">
                                <div className="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><I n="book" size={28}/></div>
                                <div><div className="text-4xl font-extrabold text-slate-800">{stats.studiedCredits}</div><div className="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1">Tín chỉ tích lũy</div></div>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 relative overflow-hidden group">
                            <div className="absolute right-0 top-0 w-32 h-32 bg-emerald-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                            <div className="flex items-center gap-4 relative z-10">
                                <div className="w-14 h-14 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center"><I n="grad" size={28}/></div>
                                <div><div className="text-4xl font-extrabold text-slate-800">{stats.cpa}</div><div className="text-xs font-bold text-emerald-600 uppercase tracking-wider mt-1 bg-emerald-50 px-2 py-0.5 rounded-full">CPA Tạm tính</div></div>
                            </div>
                        </div>
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl shadow-xl text-white flex flex-col justify-center">
                            <div className="flex justify-between items-end mb-2">
                                <div className="font-bold text-lg">Tiến độ</div>
                                <div className="text-2xl font-bold">{Math.round((stats.studiedCredits/stats.totalTarget)*100) || 0}%</div>
                            </div>
                            <div className="w-full bg-white/20 rounded-full h-2 overflow-hidden">
                                <div className="bg-emerald-400 h-full transition-all duration-1000" style={{width: `${(stats.studiedCredits/stats.totalTarget)*100}%`}}></div>
                            </div>
                            <div className="text-slate-400 text-xs mt-3">Mục tiêu: {stats.totalTarget} tín chỉ</div>
                        </div>
                    </div>

                    {/* Danh sách môn học (Render từ dataToUse) */}
                    <div className="space-y-6">
                        {dataToUse.map(sec => {
                            const isExpanded = expandedSections.includes(sec.id);
                            const finishedCount = sec.courses.filter(c => statusMap[c.code] === 'studied').length;
                            
                            return (
                                <div key={sec.id} className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition-all">
                                    <button onClick={() => toggleSection(sec.id)} className="w-full px-6 py-4 flex justify-between items-center bg-white">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-1.5 h-10 rounded-full ${finishedCount === sec.courses.length ? 'bg-emerald-500' : 'bg-indigo-500'}`}></div>
                                            <div className="text-left">
                                                <div className="font-bold text-slate-800 text-lg">{sec.title}</div>
                                                <div className="text-xs text-slate-500 font-medium mt-0.5">{sec.requiredCredits} tín chỉ • Đã xong {finishedCount} môn</div>
                                            </div>
                                        </div>
                                        <div className={`w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}><I n="down" size={16}/></div>
                                    </button>
                                    
                                    {isExpanded && <div className="p-4 bg-slate-50/50 grid grid-cols-1 lg:grid-cols-2 gap-4 border-t border-slate-100">
                                        {sec.courses.map(c => {
                                            const st = statusMap[c.code];
                                            const sc = scoreMap ? scoreMap[c.code] : '';
                                            return (
                                                <div key={c.code} className={`p-4 rounded-xl border transition-all relative group ${st === 'studied' ? 'bg-white border-emerald-200 shadow-sm' : st === 'studying' ? 'bg-white border-orange-200 shadow-sm' : 'bg-slate-50 border-slate-100 opacity-70 hover:opacity-100 hover:bg-white hover:border-indigo-100'}`}>
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1 pr-4">
                                                            <div className="flex items-center gap-2 mb-1"><span className="text-[10px] font-mono font-bold px-2 py-0.5 rounded bg-slate-100 text-slate-500">{c.code}</span>{c.required && <span className="w-2 h-2 rounded-full bg-red-400" title="Bắt buộc"></span>}</div>
                                                            <div className="font-bold text-slate-700 leading-tight mb-1">{c.name}</div>
                                                            <div className="text-xs text-slate-400">{c.credits} TC</div>
                                                        </div>
                                                        <div className="flex flex-col gap-1">
                                                            <button onClick={() => handleStatus(c.code, 'studying')} className={`p-2 rounded-lg transition-all ${st==='studying'?'bg-orange-500 text-white shadow-lg shadow-orange-200':'bg-slate-100 text-slate-300 hover:bg-orange-100 hover:text-orange-500'}`}><I n="clock" size={16}/></button>
                                                            <button onClick={() => handleStatus(c.code, 'studied')} className={`p-2 rounded-lg transition-all ${st==='studied'?'bg-emerald-500 text-white shadow-lg shadow-emerald-200':'bg-slate-100 text-slate-300 hover:bg-emerald-100 hover:text-emerald-500'}`}><I n="check" size={16}/></button>
                                                        </div>
                                                    </div>
                                                    {st === 'studied' && (
                                                        <div className="mt-3 pt-3 border-t border-slate-100 flex items-center justify-between animate-in fade-in slide-in-from-top-1">
                                                            <label className="text-xs font-bold text-emerald-600 uppercase tracking-wide">Điểm số</label>
                                                            <div className="relative"><input type="number" step="0.1" min="0" max="10" placeholder="0.0" className="w-20 pl-3 pr-2 py-1.5 text-right text-sm font-bold text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all" value={sc || ''} onChange={e => handleScore(c.code, e.target.value)} disabled={isReadOnly}/></div>
                                                        </div>
                                                    )}
                                                </div>
                                            )
                                        })}
                                    </div>}
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

    // --- COMPONENT: LỊCH THÁNG (CHỈ HIỆN THI & TASK) ---
        const MonthCalendar = ({ examSchedule, taskList }) => { 
            // ^ Đã xóa scheduleList khỏi tham số nhận vào
            const [currentDate, setCurrentDate] = useState(new Date());

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const getFirstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
                setCurrentDate(newDate);
            };

            const daysInMonth = getDaysInMonth(currentDate);
            const firstDay = getFirstDayOfMonth(currentDate);
            const days = [];

            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(new Date(currentDate.getFullYear(), currentDate.getMonth(), i));

            // LOGIC: Chỉ lấy Lịch thi và Task
            const getEventsForDay = (date) => {
                if (!date) return [];
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${d}`;
                
                // 1. Lịch Thi (Đỏ)
                const exams = (examSchedule || []).filter(e => e.date === dateStr).map(e => ({ ...e, type: 'exam' }));

                // 2. Nhiệm vụ (Vàng)
                const tasks = (taskList || []).filter(t => t.dueDate === dateStr && !t.completed).map(t => ({ ...t, type: 'task', subject: t.title }));

                return [...exams, ...tasks]; // Không còn classes nữa
            };

            const isToday = (date) => {
                if (!date) return false;
                const today = new Date();
                return date.getDate() === today.getDate() &&
                       date.getMonth() === today.getMonth() &&
                       date.getFullYear() === today.getFullYear();
            };

            return (
                <div className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 mb-8 animate-in fade-in duration-500">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div className="flex items-center gap-4">
                            <h2 className="text-xl font-extrabold text-slate-800 capitalize tracking-tight">
                                Tháng {currentDate.getMonth() + 1}, {currentDate.getFullYear()}
                            </h2>
                            <div className="flex gap-1 bg-slate-100 p-1 rounded-full">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-white hover:shadow-sm rounded-full text-slate-500 transition-all"><I n="left" size={16}/></button>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-white hover:shadow-sm rounded-full text-slate-500 transition-all"><I n="right" size={16}/></button>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-3 text-[10px] font-bold bg-slate-50 px-3 py-2 rounded-xl border border-slate-100">
                            <span className="flex items-center gap-1.5"><span className="w-2 h-2 rounded-full bg-rose-500"></span> Thi</span>
                            <span className="flex items-center gap-1.5"><span className="w-2 h-2 rounded-full bg-amber-500"></span> Deadline</span>
                        </div>
                    </div>

                    <div className="border border-slate-100 rounded-2xl overflow-hidden shadow-[0_0_0_1px_rgba(241,245,249,1)]">
                        <div className="grid grid-cols-7 bg-slate-50/80 border-b border-slate-100 backdrop-blur-sm">
                            {['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'].map(d => (
                                <div key={d} className="py-3 text-center text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider">{d}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 auto-rows-fr bg-white">
                            {days.map((date, idx) => {
                                if (!date) return <div key={idx} className="h-28 md:h-36 border-b border-r border-slate-50 bg-slate-50/30"></div>;
                                
                                const events = getEventsForDay(date);
                                const today = isToday(date);

                                return (
                                    <div key={idx} className={`h-28 md:h-36 border-b border-r border-slate-50 p-1.5 relative group transition-all hover:bg-slate-50/80 ${today ? 'bg-indigo-50/20' : ''}`}>
                                        <div className={`w-6 h-6 flex items-center justify-center rounded-lg text-xs font-bold mb-1 transition-all
                                            ${today ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200 scale-105' : 'text-slate-500 group-hover:text-indigo-600'}`}>
                                            {date.getDate()}
                                        </div>
                                        
                                        <div className="space-y-1 overflow-y-auto max-h-[calc(100%-2rem)] no-scrollbar">
                                            {events.map((ev, i) => (
                                                <div key={i} className={`text-[9px] px-1.5 py-1 rounded-md font-bold truncate flex items-center gap-1.5 border transition-transform hover:scale-[1.02] cursor-default
                                                    ${ev.type === 'exam' ? 'bg-rose-50 text-rose-700 border-rose-100' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>
                                                    <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${ev.type === 'exam' ? 'bg-rose-500' : 'bg-amber-500'}`}></span>
                                                    <span className="truncate">{ev.subject}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: LỊCH TRÌNH (V11.0 - GROUP BY DAY & END TIME) ---
        const ScheduleView = ({ scheduleList, updateScheduleList, taskList, updateTaskList, timetableData, updateTimetableData, examSchedule, updateExamSchedule, isReadOnly }) => {
            const [viewMode, setViewMode] = useState('month'); 
            
            // STATES MODAL (Đã thêm endTime vào state mặc định)
            const [showClassModal, setShowClassModal] = useState(false);
            const [newClass, setNewClass] = useState({ subject: '', room: '', day: 'Thứ 2', time: '07:00', endTime: '08:50' });
            
            const [showTaskModal, setShowTaskModal] = useState(false);
            const [newTask, setNewTask] = useState({ title: '', course: '', priority: 'medium', dueDate: '', dueTime: '' });
            
            const [showGridModal, setShowGridModal] = useState(false);
            const [selectedCell, setSelectedCell] = useState(null);
            const [gridInput, setGridInput] = useState({ subject: "", room: "" });
            
            const [showExamModal, setShowExamModal] = useState(false);
            const [newExam, setNewExam] = useState({ subject: '', date: '', time: '', room: '', format: 'Vấn đáp' });

            // --- 1. LOGIC MÀU SẮC THÔNG MINH ---
            const uniqueSubjects = useMemo(() => {
                const subjects = new Set();
                Object.values(timetableData).forEach(cell => {
                    const name = (typeof cell === 'object' && cell !== null) ? cell.subject : cell;
                    if (name) subjects.add(name.trim());
                });
                return Array.from(subjects).sort();
            }, [timetableData]);

            const getSubjectColor = (subjectName) => {
                if (!subjectName) return 'bg-white hover:bg-slate-50';
                const PALETTE = [
                    'bg-red-50 text-red-700 border-red-200', 'bg-blue-50 text-blue-700 border-blue-200',
                    'bg-emerald-50 text-emerald-700 border-emerald-200', 'bg-amber-50 text-amber-700 border-amber-200',
                    'bg-purple-50 text-purple-700 border-purple-200', 'bg-cyan-50 text-cyan-700 border-cyan-200',
                    'bg-rose-50 text-rose-700 border-rose-200', 'bg-indigo-50 text-indigo-700 border-indigo-200',
                    'bg-lime-50 text-lime-700 border-lime-200', 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200',
                    'bg-orange-50 text-orange-700 border-orange-200', 'bg-teal-50 text-teal-700 border-teal-200',
                    'bg-sky-50 text-sky-700 border-sky-200', 'bg-violet-50 text-violet-700 border-violet-200',
                    'bg-pink-50 text-pink-700 border-pink-200', 'bg-yellow-50 text-yellow-700 border-yellow-200',
                    'bg-green-50 text-green-700 border-green-200', 'bg-slate-100 text-slate-700 border-slate-300',
                    'bg-stone-100 text-stone-700 border-stone-300', 'bg-zinc-100 text-zinc-700 border-zinc-300'
                ];
                const index = uniqueSubjects.indexOf(subjectName.trim());
                if (index === -1) return PALETTE[0];
                return PALETTE[index % PALETTE.length];
            };

            // --- 2. LOGIC GOM NHÓM THEO THỨ (MỚI) ---
            const groupedClasses = useMemo(() => {
                const daysOrder = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'];
                return daysOrder.map(day => ({
                    day,
                    // Lọc các lớp thuộc thứ này và sắp xếp theo giờ bắt đầu
                    classes: scheduleList
                        .filter(c => c.day === day)
                        .sort((a, b) => a.time.localeCompare(b.time))
                })).filter(group => group.classes.length > 0); // Chỉ lấy thứ nào có môn học
            }, [scheduleList]);

            // --- ACTIONS ---
            const addClass = () => {
                if(isReadOnly) return;
                if(!newClass.subject) return alert("Vui lòng nhập tên môn!");
                updateScheduleList([...scheduleList, { ...newClass, id: Date.now() }]);
                setShowClassModal(false);
                setNewClass({ subject: '', room: '', day: 'Thứ 2', time: '07:00', endTime: '08:50' });
            };

            const addTask = () => {
                if(isReadOnly) return;
                if(!newTask.title) return alert("Nhập tên nhiệm vụ!");
                const list = [...(taskList||[]), { ...newTask, id: Date.now(), completed: false }];
                updateTaskList(list);
                setShowTaskModal(false);
                setNewTask({ title: '', course: '', priority: 'medium', dueDate: '', dueTime: '' });
            };

            const toggleTask = (id) => {
                if(isReadOnly) return;
                updateTaskList((taskList||[]).map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            };

            const deleteTask = (e, id) => {
                e.stopPropagation();
                if(isReadOnly) return;
                if(confirm("Xóa mục này?")) updateTaskList((taskList||[]).filter(t => t.id !== id));
            };

            const addToGoogleCalendar = (exam) => {
                if (!exam.date || !exam.time) return alert("Thiếu ngày giờ!");
                const start = new Date(`${exam.date}T${exam.time}`).toISOString().replace(/-|:|\.\d\d\d/g, "");
                const end = new Date(new Date(`${exam.date}T${exam.time}`).getTime() + 90*60000).toISOString().replace(/-|:|\.\d\d\d/g, "");
                const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent("Thi: "+exam.subject)}&dates=${start}/${end}&details=${encodeURIComponent(exam.format)}&location=${encodeURIComponent(exam.room)}`;
                window.open(url, '_blank');
            };

            const addExam = () => { 
                if(isReadOnly) return; 
                if(!newExam.subject || !newExam.date) return alert("Thiếu thông tin!"); 
                const list = [...(examSchedule||[]), {...newExam, id: Date.now()}].sort((a,b)=>new Date(a.date)-new Date(b.date));
                updateExamSchedule(list); setShowExamModal(false); 
                setNewExam({ subject: '', date: '', time: '', room: '', format: 'Vấn đáp' });
            };

            // --- TKB LOGIC ---
            const handleCellClick = (d, p) => { 
                if(isReadOnly) return; 
                setSelectedCell({ dayIndex: d, period: p }); 
                const current = timetableData[`${d}-${p}`];
                if (typeof current === 'object' && current !== null) {
                    setGridInput({ subject: current.subject || "", room: current.room || "" });
                } else {
                    setGridInput({ subject: current || "", room: "" });
                }
                setShowGridModal(true); 
            };
            const saveGridCell = () => { updateTimetableData({ ...timetableData, [`${selectedCell.dayIndex}-${selectedCell.period}`]: gridInput }); setShowGridModal(false); };
            const deleteGridCell = () => { 
                const next = {...timetableData}; 
                next[`${selectedCell.dayIndex}-${selectedCell.period}`] = null; 
                updateTimetableData(next); 
                setShowGridModal(false); 
            };
            
            const isSameContent = (cellA, cellB) => {
                if (!cellA || !cellB) return false;
                const subjA = (typeof cellA === 'object') ? cellA.subject : cellA;
                const subjB = (typeof cellB === 'object') ? cellB.subject : cellB;
                const roomA = (typeof cellA === 'object') ? cellA.room : '';
                const roomB = (typeof cellB === 'object') ? cellB.room : '';
                return subjA === subjB && roomA === roomB;
            };

            const getCellProps = (dayIndex, period) => {
                const current = timetableData[`${dayIndex}-${period}`];
                if (!current || (typeof current === 'object' && !current.subject)) return { render: true, rowSpan: 1 };
                const prev = timetableData[`${dayIndex}-${period-1}`];
                if (isSameContent(current, prev)) return { render: false, rowSpan: 1 };
                let span = 1; while (period + span <= 12 && isSameContent(current, timetableData[`${dayIndex}-${period+span}`])) span++;
                return { render: true, rowSpan: span };
            };

            const getPriorityColor = (p) => {
                if(p === 'high') return 'bg-rose-50 text-rose-600 border-rose-200 font-bold';
                if(p === 'medium') return 'bg-orange-50 text-orange-600 border-orange-200 font-bold';
                return 'bg-slate-100 text-slate-500 border-slate-200 font-bold';
            };

            const getClassCardStyle = (index) => {
                const styles = [
                    { bg: 'bg-violet-50/50', border: 'border-violet-200', accent: 'bg-violet-500', text: 'text-violet-900', subtext: 'text-violet-600', badge: 'bg-white text-violet-700 shadow-sm' },
                    { bg: 'bg-sky-50/50', border: 'border-sky-200', accent: 'bg-sky-500', text: 'text-sky-900', subtext: 'text-sky-600', badge: 'bg-white text-sky-700 shadow-sm' },
                    { bg: 'bg-teal-50/50', border: 'border-teal-200', accent: 'bg-teal-500', text: 'text-teal-900', subtext: 'text-teal-600', badge: 'bg-white text-teal-700 shadow-sm' },
                    { bg: 'bg-rose-50/50', border: 'border-rose-200', accent: 'bg-rose-500', text: 'text-rose-900', subtext: 'text-rose-600', badge: 'bg-white text-rose-700 shadow-sm' },
                    { bg: 'bg-amber-50/50', border: 'border-amber-200', accent: 'bg-amber-500', text: 'text-amber-900', subtext: 'text-amber-600', badge: 'bg-white text-amber-700 shadow-sm' },
                ];
                return styles[index % styles.length];
            };

            const pendingTasks = (taskList || []).filter(t => !t.completed).sort((a,b) => {
                const pOrder = { high: 1, medium: 2, low: 3 };
                if (pOrder[a.priority] !== pOrder[b.priority]) return pOrder[a.priority] - pOrder[b.priority];
                return new Date(a.dueDate || '9999') - new Date(b.dueDate || '9999');
            });
            const completedTasks = (taskList || []).filter(t => t.completed);

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto font-sans pb-32">
                     {/* Header */}
                     <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
                        <div className="text-center md:text-left">
                            <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight mb-1">Lịch trình</h1>
                            <p className="text-slate-500 text-sm font-medium">Quản lý lớp học, nhiệm vụ và thi cử</p>
                        </div>
                        
                        <div className="bg-white p-1.5 rounded-2xl flex shadow-sm border border-slate-200 overflow-x-auto max-w-full">
                            {[
                                {id:'month',l:'Lịch tháng'}, 
                                {id:'list',l:'Lớp học'}, 
                                {id:'tasks',l:'Nhiệm vụ'}, 
                                {id:'table',l:'TKB Tuần'}, 
                                {id:'exam',l:'Lịch thi'}
                            ].map(mode => (
                                <button key={mode.id} onClick={()=>setViewMode(mode.id)} className={`px-5 py-2.5 text-xs font-bold rounded-xl transition-all whitespace-nowrap ${viewMode===mode.id ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:text-slate-900 hover:bg-slate-50'}`}>{mode.l}</button>
                            ))}
                        </div>
                     </div>

                     {/* VIEW 4: LỊCH THÁNG */}
                     {viewMode === 'month' && <MonthCalendar examSchedule={examSchedule} taskList={taskList} />}

                     {/* VIEW 1: LỚP HỌC (ĐÃ SỬA: GOM NHÓM THEO NGÀY) */}
                     {viewMode === 'list' && (
                        <div className="space-y-10 animate-in fade-in slide-in-from-bottom-4">
                            {groupedClasses.length > 0 ? (
                                groupedClasses.map((group) => (
                                    <div key={group.day}>
                                        <h3 className="text-lg font-extrabold text-slate-700 mb-4 flex items-center gap-3">
                                            <div className="w-1.5 h-6 bg-indigo-500 rounded-full"></div>
                                            {group.day}
                                        </h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                            {group.classes.map((item, idx) => {
                                                const theme = getClassCardStyle(idx);
                                                return (
                                                    <div key={item.id} className={`rounded-2xl overflow-hidden shadow-sm hover:shadow-xl relative group transition-all backdrop-blur-md border ${theme.border} ${theme.bg}`}>
                                                        <div className="p-5 pl-7 relative z-10">
                                                            <div className="flex justify-between items-start mb-3">
                                                                <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-lg ${theme.badge}`}>
                                                                    {item.time} - {item.endTime || '??:??'}
                                                                </span>
                                                                {!isReadOnly && <button onClick={() => updateScheduleList(scheduleList.filter(i => i.id !== item.id))} className={`opacity-0 group-hover:opacity-100 transition-opacity ${theme.subtext} hover:text-red-500`}><I n="trash" size={18}/></button>}
                                                            </div>
                                                            
                                                            <h3 className={`text-xl font-extrabold ${theme.text} mb-4 leading-tight`}>{item.subject}</h3>
                                                            
                                                            <div className={`flex flex-col gap-2 text-sm font-medium ${theme.subtext}`}>
                                                                <div className="flex items-center gap-3"><div className="bg-white/50 p-1.5 rounded-full"><I n="grad" size={14}/></div> <span>{item.room}</span></div>
                                                            </div>
                                                        </div>
                                                        <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${theme.accent}`}></div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-3xl">Chưa có lớp học nào</div>
                            )}
                            
                            {!isReadOnly && <button onClick={() => setShowClassModal(true)} className="fixed bottom-24 right-6 md:bottom-10 md:right-10 bg-slate-900 hover:bg-slate-800 text-white p-4 rounded-full shadow-xl shadow-slate-300 z-50 hover:scale-110 transition-transform"><I n="plus" size={24}/></button>}
                        </div>
                     )}

                     {/* VIEW 2: NHIỆM VỤ */}
                     {viewMode === 'tasks' && (
                        <div className="animate-in fade-in space-y-6">
                            <div>
                                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-lg">📌 Cần làm <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">{pendingTasks.length}</span></h3>
                                <div className="space-y-3">
                                    {pendingTasks.map(item => (
                                        <div key={item.id} onClick={() => toggleTask(item.id)} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer flex items-center gap-4 transition-all hover:border-indigo-300 group">
                                            <div className="w-5 h-5 rounded-full border-2 border-slate-300 group-hover:border-indigo-500 transition-colors"></div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`text-[10px] px-2 py-0.5 rounded uppercase ${getPriorityColor(item.priority)}`}>{item.priority}</span>
                                                    {item.course && <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200 uppercase">{item.course}</span>}
                                                </div>
                                                <div className="font-bold text-slate-800">{item.title}</div>
                                            </div>
                                            {(item.dueDate || item.dueTime) && (<div className={`text-xs font-mono font-bold ${item.priority === 'high' ? 'text-red-500' : 'text-slate-400'}`}>{item.dueTime} {item.dueDate ? new Date(item.dueDate).toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit'}) : ''}</div>)}
                                            {!isReadOnly && <button onClick={(e) => deleteTask(e, item.id)} className="p-2 text-slate-300 hover:text-red-500 transition-colors"><I n="trash" size={16}/></button>}
                                        </div>
                                    ))}
                                    {pendingTasks.length === 0 && <div className="text-center py-8 text-slate-400 italic text-sm">Không có nhiệm vụ nào.</div>}
                                </div>
                            </div>
                            {completedTasks.length > 0 && (
                                <div>
                                    <h3 className="font-bold text-slate-400 mb-3 flex items-center gap-2 text-sm uppercase tracking-wider mt-8">✅ Đã hoàn thành <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">{completedTasks.length}</span></h3>
                                    <div className="space-y-2 opacity-60 hover:opacity-100 transition-opacity">
                                        {completedTasks.map(item => (
                                            <div key={item.id} onClick={() => toggleTask(item.id)} className="bg-slate-50 p-3 rounded-lg border border-slate-100 flex items-center gap-4 cursor-pointer">
                                                <div className="w-5 h-5 rounded-full bg-indigo-500 flex items-center justify-center"><I n="check" size={12} className="text-white"/></div>
                                                <div className="flex-1 font-medium text-slate-500 line-through text-sm">{item.title}</div>
                                                {!isReadOnly && <button onClick={(e) => deleteTask(e, item.id)} className="text-slate-300 hover:text-red-500"><I n="trash" size={14}/></button>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {!isReadOnly && <button onClick={() => setShowTaskModal(true)} className="fixed bottom-24 right-6 md:bottom-10 md:right-10 bg-slate-900 hover:bg-slate-800 text-white p-4 rounded-full shadow-xl shadow-slate-300 z-50 hover:scale-110 transition-transform"><I n="plus" size={24}/></button>}
                        </div>
                     )}

                     {/* VIEW 3: LỊCH THI */}
                     {viewMode === 'exam' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5 animate-in fade-in">
                            {(examSchedule || []).map(item => (
                                <div key={item.id} className="bg-white rounded-2xl border border-rose-100 shadow-sm overflow-hidden relative group hover:shadow-lg transition-all">
                                    <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-rose-500"></div>
                                    <div className="p-5 pl-7 bg-rose-50/30">
                                        <div className="flex justify-between items-start mb-3">
                                            <span className="text-[10px] font-bold bg-white text-rose-600 border border-rose-200 px-2 py-1 rounded uppercase flex items-center gap-1 shadow-sm">
                                                <I n="clock" size={10}/> {new Date(item.date).toLocaleDateString('vi-VN')}
                                            </span>
                                            <button onClick={() => addToGoogleCalendar(item)} className="text-[10px] font-bold bg-white text-slate-500 hover:text-indigo-600 px-2 py-1 rounded border border-slate-200 transition-colors shadow-sm">Calendar</button>
                                        </div>
                                        <h3 className="text-lg font-extrabold text-slate-800 mb-4 leading-snug">{item.subject}</h3>
                                        <div className="flex items-center justify-between text-xs font-medium text-slate-600 mt-2">
                                            <div className="flex items-center gap-3">
                                                <span className="flex items-center gap-1.5"><span className="w-1.5 h-1.5 bg-rose-400 rounded-full"></span> {item.time}</span>
                                                <span className="flex items-center gap-1.5"><span className="w-1.5 h-1.5 bg-slate-400 rounded-full"></span> {item.room}</span>
                                            </div>
                                            <span className="bg-white px-2 py-0.5 rounded border border-rose-100 text-rose-600 font-bold">{item.format}</span>
                                        </div>
                                        {!isReadOnly && <button onClick={() => updateExamSchedule(examSchedule.filter(i => i.id !== item.id))} className="absolute bottom-4 right-4 text-slate-300 hover:text-rose-600 opacity-0 group-hover:opacity-100 transition-all"><I n="trash" size={18}/></button>}
                                    </div>
                                </div>
                            ))}
                            {(!examSchedule || examSchedule.length === 0) && <div className="col-span-full text-center text-slate-400 py-16 border-2 border-dashed border-rose-100 bg-rose-50/10 rounded-3xl">Chưa có lịch thi.</div>}
                            {!isReadOnly && <button onClick={() => setShowExamModal(true)} className="fixed bottom-24 right-6 md:bottom-10 md:right-10 bg-rose-600 hover:bg-rose-700 text-white p-4 rounded-full shadow-xl shadow-rose-300 z-50 hover:scale-110 transition-transform"><I n="plus" size={24}/></button>}
                        </div>
                     )}

                     {/* VIEW 5: TKB TUẦN (TABLE) */}
                     {viewMode === 'table' && (
                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden animate-in fade-in">
                            <div className="overflow-x-auto"><div className="min-w-[800px]"><table className="w-full border-collapse"><thead><tr><th className="p-3 bg-slate-50 text-xs font-bold text-slate-400 uppercase w-12 border-b border-slate-100">Tiết</th>{["T2", "T3", "T4", "T5", "T6", "T7", "CN"].map(d => <th key={d} className="p-3 bg-slate-50 text-xs font-bold text-slate-600 border-b border-l border-slate-100 w-[13%]">{d}</th>)}</tr></thead><tbody>{Array.from({length: 12}, (_, i) => i + 1).map(p => (<tr key={p}><td className="p-2 text-center text-xs font-bold text-slate-400 bg-slate-50/50 border-b border-slate-100 h-16">{p}</td>{Array.from({length: 7}).map((_, dIdx) => { const { render, rowSpan } = getCellProps(dIdx, p); if (!render) return null; const content = timetableData[`${dIdx}-${p}`]; const cellData = (typeof content === 'object' && content !== null) ? content : { subject: content, room: '' }; const cellColor = cellData.subject ? getSubjectColor(cellData.subject) : 'hover:bg-slate-50'; return (<td key={dIdx} rowSpan={rowSpan} onClick={() => handleCellClick(dIdx, p)} className={`border-b border-l border-slate-100 p-1 cursor-pointer transition-colors relative group h-16 ${cellColor} ${!cellData.subject && 'hover:bg-slate-50'}`}>{cellData.subject && (<div className="w-full h-full flex flex-col items-center justify-center text-center p-1 leading-tight gap-0.5"><div className="text-[10px] font-bold line-clamp-2">{cellData.subject}</div>{cellData.room && <div className="text-[9px] font-mono font-bold bg-white/40 px-1.5 py-0.5 rounded shadow-sm">{cellData.room}</div>}</div>)}</td>); })}</tr>))}</tbody></table></div></div>
                        </div>
                     )}

                     {/* MODAL CLASS (ĐÃ THÊM GIỜ KẾT THÚC) */}
                     {showClassModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                                <h3 className="font-extrabold text-xl mb-4 text-slate-800">Thêm lớp học</h3>
                                <div className="mb-3"><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">Tên môn học</label><input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm focus:border-indigo-500 outline-none font-bold" placeholder="Nhập tên môn..." value={newClass.subject} onChange={e => setNewClass({...newClass, subject: e.target.value})} /></div>
                                <div className="mb-3"><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">Thứ</label><select className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm outline-none font-medium" value={newClass.day} onChange={e => setNewClass({...newClass, day: e.target.value})}>{['Thứ 2','Thứ 3','Thứ 4','Thứ 5','Thứ 6','Thứ 7','Chủ nhật'].map(d=><option key={d} value={d}>{d}</option>)}</select></div>
                                <div className="flex gap-3 mb-3">
                                    <div className="flex-1"><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">Bắt đầu</label><input type="time" className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm outline-none font-medium" value={newClass.time} onChange={e => setNewClass({...newClass, time: e.target.value})} /></div>
                                    <div className="flex-1"><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">Kết thúc</label><input type="time" className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm outline-none font-medium" value={newClass.endTime} onChange={e => setNewClass({...newClass, endTime: e.target.value})} /></div>
                                </div>
                                <input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl mb-6 text-sm outline-none font-medium" placeholder="Phòng học (VD: A2-301)" value={newClass.room} onChange={e => setNewClass({...newClass, room: e.target.value})} />
                                <div className="flex justify-end gap-3"><button onClick={() => setShowClassModal(false)} className="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-50 rounded-xl">Hủy</button><button onClick={addClass} className="px-5 py-2.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800">Lưu</button></div>
                            </div>
                        </div>
                     )}

                     {/* CÁC MODAL KHÁC GIỮ NGUYÊN */}
                     {showTaskModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                                <h3 className="font-extrabold text-xl mb-4 text-slate-800">Thêm nhiệm vụ</h3>
                                <input autoFocus className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl mb-3 text-sm focus:border-indigo-500 outline-none font-medium" placeholder="Tên nhiệm vụ..." value={newTask.title} onChange={e => setNewTask({...newTask, title: e.target.value})} />
                                <input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl mb-3 text-sm outline-none font-medium" placeholder="Môn học (Tùy chọn)..." value={newTask.course} onChange={e => setNewTask({...newTask, course: e.target.value})} />
                                <div className="mb-3 flex gap-2">{['high', 'medium', 'low'].map(p => (<button key={p} onClick={() => setNewTask({...newTask, priority: p})} className={`flex-1 py-2 rounded-xl text-xs font-bold border transition-all ${newTask.priority === p ? getPriorityColor(p) + ' ring-1 ring-offset-1' : 'bg-white border-slate-200 text-slate-400'}`}>{p.toUpperCase()}</button>))}</div>
                                <div className="flex gap-3 mb-6"><input type="date" className="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm flex-1 outline-none font-medium" value={newTask.dueDate} onChange={e => setNewTask({...newTask, dueDate: e.target.value})} /><input type="time" className="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm w-28 outline-none font-medium" value={newTask.dueTime} onChange={e => setNewTask({...newTask, dueTime: e.target.value})} /></div>
                                <div className="flex justify-end gap-3"><button onClick={() => setShowTaskModal(false)} className="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-50 rounded-xl">Hủy</button><button onClick={addTask} className="px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold">Thêm Task</button></div>
                            </div>
                        </div>
                     )}
                     {showGridModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                                <h3 className="font-extrabold text-xl mb-1 text-slate-800">Cập nhật TKB</h3>
                                <p className="text-xs text-slate-400 mb-6 font-bold uppercase tracking-wide">Thứ {selectedCell.dayIndex + 2} • Tiết {selectedCell.period}</p>
                                <div className="space-y-3 mb-6">
                                    <div><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">Môn học</label><input autoFocus className="w-full bg-slate-50 border border-slate-200 p-4 rounded-2xl text-sm outline-none font-bold text-slate-700" placeholder="Nhập tên môn..." value={gridInput.subject} onChange={e => setGridInput({...gridInput, subject: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">Giảng đường / Phòng</label><input className="w-full bg-slate-50 border border-slate-200 p-4 rounded-2xl text-sm outline-none font-bold text-slate-700" placeholder="VD: A2-405" value={gridInput.room} onChange={e => setGridInput({...gridInput, room: e.target.value})} /></div>
                                </div>
                                <div className="flex justify-end gap-2"><button onClick={() => setShowGridModal(false)} className="px-4 py-2 text-slate-400 font-bold hover:text-slate-600">Hủy</button><button onClick={deleteGridCell} className="px-4 py-2 text-rose-500 hover:bg-rose-50 rounded-xl font-bold">Xóa</button><button onClick={saveGridCell} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold">Lưu</button></div>
                            </div>
                        </div>
                     )}
                     {showExamModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                                <h3 className="font-extrabold text-xl mb-4 text-rose-600">Thêm lịch thi</h3>
                                <div className="mb-3"><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">Tên môn thi</label><input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm focus:border-rose-500 outline-none font-bold" placeholder="Nhập tên môn..." value={newExam.subject} onChange={e => setNewExam({...newExam, subject: e.target.value})} /></div>
                                <div className="flex gap-3 mb-3"><input type="date" className="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm flex-1 outline-none font-medium" value={newExam.date} onChange={e => setNewExam({...newExam, date: e.target.value})} /><input type="time" className="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm w-28 outline-none font-medium" value={newExam.time} onChange={e => setNewExam({...newExam, time: e.target.value})} /></div>
                                <div className="flex gap-3 mb-6"><input className="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm flex-1 outline-none font-medium" placeholder="Phòng thi" value={newExam.room} onChange={e => setNewExam({...newExam, room: e.target.value})} /><select className="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm outline-none font-medium" value={newExam.format} onChange={e => setNewExam({...newExam, format: e.target.value})}><option value="Vấn đáp">Vấn đáp</option><option value="Tự luận">Tự luận</option><option value="Trắc nghiệm">Trắc nghiệm</option></select></div>
                                <div className="flex justify-end gap-3"><button onClick={() => setShowExamModal(false)} className="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-50 rounded-xl">Hủy</button><button onClick={addExam} className="px-5 py-2.5 bg-rose-600 text-white rounded-xl font-bold">Lưu lịch</button></div>
                            </div>
                        </div>
                     )}
                </div>
            )
        }

        // --- 1. COMPONENT: CHI TIẾT BÀI HỌC (V15.1 - CÔNG THỨC TOÁN RÕ NÉT) ---
        const SubjectDetail = ({ subject, onBack, onUpdate, isReadOnly, showLinks = true }) => {
            const [activeTab, setActiveTab] = useState('flashcards');
            const [showAddModal, setShowAddModal] = useState(false);
            const [inputData, setInputData] = useState({ title: '', content: '', link: '', group: '' });
            const [collapsedGroups, setCollapsedGroups] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [flippedCards, setFlippedCards] = useState([]);

            // --- HÀM RENDER TOÁN HỌC (ĐÃ SỬA STYLE ĐẸP HƠN) ---
            const RenderMath = ({ text }) => {
                if (!text) return null;
                const parts = text.split(/(\$[^\$]+\$)/g);
                
                return (
                    <span className="leading-loose"> {/* Tăng khoảng cách dòng để công thức không bị dính */}
                        {parts.map((part, index) => {
                            if (part.startsWith('$') && part.endsWith('$')) {
                                const math = part.slice(1, -1);
                                try {
                                    if (window.katex) {
                                        const html = window.katex.renderToString(math, { throwOnError: false });
                                        // --- STYLE MỚI CHO CÔNG THỨC ---
                                        // text-blue-700: Màu xanh đậm
                                        // bg-blue-50: Nền xanh nhạt
                                        // px-1.5 rounded: Bo góc và đệm
                                        // font-serif: Font có chân (giống sách Toán)
                                        return <span key={index} dangerouslySetInnerHTML={{__html: html}} 
                                            className="text-blue-700 font-bold bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100 font-serif mx-0.5 inline-block" />;
                                    }
                                } catch (e) {
                                    return <span key={index} className="text-red-500 font-bold bg-red-50 px-1 rounded">{part}</span>;
                                }
                            }
                            return <span key={index}>{part}</span>;
                        })}
                    </span>
                );
            };

            const getFilteredItems = () => {
                const items = subject[activeTab] || [];
                if (!searchTerm) return items;
                const lower = searchTerm.toLowerCase();
                return items.filter(item => 
                    (item.title && item.title.toLowerCase().includes(lower)) ||
                    (item.content && item.content.toLowerCase().includes(lower)) ||
                    (item.group && item.group.toLowerCase().includes(lower))
                );
            };

            const addItem = () => {
                if (isReadOnly) return;
                if (!inputData.title) return alert(activeTab === 'flashcards' ? "Vui lòng nhập câu hỏi!" : "Vui lòng nhập tiêu đề!");
                
                const finalGroup = inputData.group ? inputData.group.trim() : 'Chung'; 
                const newItem = { 
                    id: Date.now(), 
                    ...inputData, 
                    group: finalGroup, 
                    date: new Date().toLocaleDateString('vi-VN') 
                };
                
                let updatedSubject = { ...subject };
                if (!updatedSubject[activeTab]) updatedSubject[activeTab] = [];
                updatedSubject[activeTab].push(newItem);
                onUpdate(updatedSubject);
                
                setInputData({ title: '', content: '', link: '', group: '' });
                setShowAddModal(false); 
            };

            const deleteItem = (e, id) => {
                e.stopPropagation();
                if (isReadOnly) return;
                if (!confirm("Bạn có chắc muốn xóa mục này không?")) return;
                let updatedSubject = { ...subject };
                updatedSubject[activeTab] = updatedSubject[activeTab].filter(i => i.id !== id);
                onUpdate(updatedSubject);
            };

            const toggleGroup = (groupName) => setCollapsedGroups(prev => prev.includes(groupName) ? prev.filter(g => g !== groupName) : [...prev, groupName]);
            const toggleFlip = (id) => setFlippedCards(prev => prev.includes(id) ? prev.filter(cardId => cardId !== id) : [...prev, id]);

            const renderContent = () => {
                const items = getFilteredItems();
                
                if (items.length === 0) return (
                    <div className="flex flex-col items-center justify-center py-24 text-slate-400 border-2 border-dashed border-slate-200 rounded-3xl mx-6 bg-slate-50/50">
                        <div className="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mb-3">
                            <I n={activeTab === 'flashcards' ? 'atom' : 'list'} size={24} className="opacity-30"/>
                        </div>
                        <span className="font-medium">Chưa có dữ liệu nào. Bấm "Thêm mới" để tạo.</span>
                    </div>
                );

                if (activeTab === 'flashcards') {
                    return (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5 px-6 pb-32 animate-in fade-in slide-in-from-bottom-2">
                            {items.map((item) => {
                                const isFlipped = flippedCards.includes(item.id);
                                return (
                                    <div key={item.id} onClick={() => toggleFlip(item.id)} className="group cursor-pointer perspective-1000 h-64 relative">
                                        <div className={`relative w-full h-full transition-all duration-500 transform-style-3d shadow-sm hover:shadow-xl rounded-2xl border border-slate-200 ${isFlipped ? 'rotate-y-180' : ''}`}>
                                            {/* MẶT TRƯỚC */}
                                            <div className="absolute inset-0 backface-hidden bg-white p-6 rounded-2xl flex flex-col justify-between">
                                                <div className="flex justify-between items-start">
                                                    <span className="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md uppercase tracking-wider">Câu hỏi</span>
                                                    {!isReadOnly && <button onClick={(e) => deleteItem(e, item.id)} className="text-slate-200 hover:text-red-500 transition-colors"><I n="trash" size={16}/></button>}
                                                </div>
                                                <div className="flex-1 flex items-center justify-center text-center px-2 overflow-hidden">
                                                    <h3 className="font-bold text-slate-800 text-lg leading-snug break-words w-full"><RenderMath text={item.title}/></h3>
                                                </div>
                                                <div className="text-center text-xs text-slate-400 font-medium mt-2">Bấm để xem đáp án</div>
                                            </div>

                                            {/* MẶT SAU */}
                                            <div className="absolute inset-0 backface-hidden rotate-y-180 bg-slate-800 p-6 rounded-2xl flex flex-col justify-between text-white">
                                                <div className="flex justify-between items-start">
                                                    <span className="text-[10px] font-bold text-white/80 bg-white/20 px-2 py-1 rounded-md uppercase tracking-wider">Đáp án</span>
                                                </div>
                                                <div className="flex-1 flex items-center justify-center text-center overflow-y-auto custom-scrollbar px-2 w-full">
                                                    {/* Ở mặt sau, ta đổi màu công thức sang màu sáng để nổi trên nền tối */}
                                                    <div className="text-lg font-medium leading-relaxed whitespace-pre-wrap break-words w-full">
                                                        {item.content && item.content.split(/(\$[^\$]+\$)/g).map((part, idx) => {
                                                            if (part.startsWith('$') && part.endsWith('$')) {
                                                                const math = part.slice(1, -1);
                                                                try {
                                                                    const html = window.katex.renderToString(math, { throwOnError: false });
                                                                    return <span key={idx} dangerouslySetInnerHTML={{__html: html}} className="text-emerald-300 font-bold bg-white/10 px-1 rounded mx-0.5 inline-block" />;
                                                                } catch(e) { return part; }
                                                            }
                                                            return part;
                                                        })}
                                                    </div>
                                                </div>
                                                <div className="text-center text-xs text-slate-400 font-medium mt-2">Bấm để quay lại</div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    );
                }

                const grouped = items.reduce((acc, item) => {
                    const g = item.group || 'Chung';
                    if (!acc[g]) acc[g] = [];
                    acc[g].push(item);
                    return acc;
                }, {});

                return (
                    <div className="px-6 pb-32 space-y-10 animate-in fade-in slide-in-from-bottom-4">
                        {Object.entries(grouped).map(([gName, gItems]) => {
                            const isCollapsed = collapsedGroups.includes(gName);
                            return (
                                <div key={gName}>
                                    <button onClick={() => toggleGroup(gName)} className="flex items-center gap-3 mb-4 group w-full text-left">
                                        <h3 className="text-lg font-bold text-slate-800 group-hover:text-indigo-600 transition-colors">{gName}</h3>
                                        <div className="h-px bg-slate-200 flex-1 group-hover:bg-indigo-200 transition-colors"></div>
                                        <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2.5 py-0.5 rounded-full">{gItems.length}</span>
                                    </button>
                                    
                                    {!isCollapsed && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            {gItems.map(item => (
                                                <div key={item.id} className="group flex flex-col justify-between p-5 rounded-2xl bg-white border border-slate-100 shadow-sm hover:shadow-md hover:border-indigo-100 transition-all duration-300">
                                                    <div className="flex items-start justify-between mb-3">
                                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-md ${item.link ? 'bg-gradient-to-br from-indigo-500 to-violet-600' : 'bg-slate-400'}`}>
                                                            <I n={item.link ? 'vid' : 'list'} size={20}/>
                                                        </div>
                                                        {!isReadOnly && <button onClick={(e) => deleteItem(e, item.id)} className="text-slate-300 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100"><I n="trash" size={16}/></button>}
                                                    </div>
                                                    
                                                    <div>
                                                        <h4 className="font-bold text-slate-800 text-sm mb-1 line-clamp-2" title={item.title}><RenderMath text={item.title}/></h4>
                                                        <div className="text-[10px] text-slate-400 font-medium">Thêm: {item.date}</div>
                                                    </div>

                                                    <div className="mt-4">
                                                        {showLinks && item.link ? (
                                                            <a href={item.link} target="_blank" className="flex items-center justify-center gap-2 w-full py-2.5 rounded-xl bg-slate-50 text-slate-600 text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all">
                                                                Mở tài liệu <I n="right" size={12}/>
                                                            </a>
                                                        ) : (
                                                            <div className="w-full py-2.5 text-center text-xs text-slate-300 bg-slate-50 rounded-xl border border-slate-100 cursor-not-allowed">Chưa có link</div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-[#F8FAFC] z-50 flex flex-col animate-in slide-in-from-right duration-300">
                    <div className="px-6 py-5 bg-white border-b border-slate-100 flex items-center gap-4 sticky top-0 z-20 shadow-sm">
                        <button onClick={onBack} className="w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-100 transition-colors text-slate-500 border border-transparent hover:border-slate-200">
                            <I n="left" size={20}/>
                        </button>
                        <div className="flex-1 min-w-0">
                            <h2 className="text-xl font-bold text-slate-900 truncate leading-tight">{subject.name}</h2>
                            <p className="text-xs text-slate-400 font-medium tracking-wide mt-0.5">{subject.code}</p>
                        </div>
                        <div className="relative w-64 hidden md:block">
                            <input className="w-full bg-slate-50 border-none rounded-xl pl-10 pr-4 py-2.5 text-sm font-medium text-slate-600 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-100 transition-all" placeholder="Tìm kiếm nội dung..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                            <I n="list" className="absolute left-3.5 top-3 text-slate-400" size={16}/>
                        </div>
                    </div>

                    <div className="px-6 pt-6 pb-2">
                        <div className="inline-flex bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm">
                            {[
                                {id: 'flashcards', l: 'Flashcards (Học bài)'}, 
                                {id: 'materials', l: 'Tài liệu (Links)'}
                            ].map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} 
                                    className={`px-6 py-2 rounded-lg text-sm font-bold transition-all duration-300 ${activeTab === t.id ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:text-slate-900 hover:bg-slate-50'}`}>
                                    {t.l}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                        {renderContent()}
                    </div>

                    {!isReadOnly && (
                        <div className="absolute bottom-8 right-8 z-30">
                            <button onClick={() => setShowAddModal(true)} className="group flex items-center gap-2 bg-slate-900 text-white pl-4 pr-6 py-3.5 rounded-full shadow-xl shadow-slate-300 hover:bg-black hover:scale-105 transition-all duration-300">
                                <div className="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center group-hover:rotate-90 transition-transform"><I n="plus" size={16}/></div>
                                <span className="font-bold text-sm">Thêm mới</span>
                            </button>
                        </div>
                    )}

                    {showAddModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-lg p-0 shadow-2xl animate-in zoom-in-95 duration-200 overflow-hidden">
                                <div className="px-6 py-5 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                                    <h3 className="font-bold text-lg text-slate-800">
                                        {activeTab === 'flashcards' ? 'Tạo Flashcard Mới' : 'Thêm Tài liệu Mới'}
                                    </h3>
                                    <button onClick={() => setShowAddModal(false)} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white hover:shadow-sm text-slate-400 transition-all"><I n="x" size={18}/></button>
                                </div>
                                
                                <div className="p-6 space-y-5">
                                    {activeTab === 'flashcards' && (
                                        <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-xs text-indigo-800">
                                            💡 <b>Mẹo Toán học:</b> Kẹp công thức giữa dấu $. <br/>
                                            VD: Gõ <code>{'$x^2$'}</code> → $x^2$, <code>{'$\\sqrt{x}$'}</code> → {'$\\sqrt{x}$'}
                                        </div>
                                    )}

                                    {activeTab === 'materials' && (
                                        <div className="space-y-1.5">
                                            <label className="text-xs font-bold text-slate-400 ml-1 uppercase">Nhóm / Chương</label>
                                            <input className="w-full bg-slate-50 border border-transparent focus:border-blue-500 rounded-xl px-4 py-3 text-sm font-medium outline-none" placeholder="VD: Chương 1..." value={inputData.group} onChange={e => setInputData({...inputData, group: e.target.value})} />
                                        </div>
                                    )}

                                    <div className="space-y-1.5">
                                        <label className="text-xs font-bold text-slate-400 ml-1 uppercase">
                                            {activeTab === 'flashcards' ? 'Câu hỏi (Mặt trước)' : 'Tiêu đề tài liệu'}
                                        </label>
                                        <input autoFocus className="w-full bg-slate-50 hover:bg-slate-100 focus:bg-white border border-transparent focus:border-indigo-500 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 transition-all outline-none" 
                                            placeholder={activeTab === 'flashcards' ? "VD: Tính $\\int x dx$" : "Nhập tiêu đề..."}
                                            value={inputData.title} onChange={e => setInputData({...inputData, title: e.target.value})} />
                                    </div>
                                    
                                    {activeTab === 'flashcards' && (
                                        <div className="space-y-1.5">
                                            <label className="text-xs font-bold text-slate-400 ml-1 uppercase">Đáp án (Mặt sau)</label>
                                            <textarea rows="4" className="w-full bg-slate-50 hover:bg-slate-100 focus:bg-white border border-transparent focus:border-indigo-500 rounded-xl px-4 py-3 text-sm font-medium text-slate-600 transition-all outline-none resize-none" 
                                                placeholder="VD: $\frac{x^2}{2} + C$" 
                                                value={inputData.content} onChange={e => setInputData({...inputData, content: e.target.value})}></textarea>
                                        </div>
                                    )}
                                    
                                    {activeTab === 'materials' && showLinks && (
                                        <div className="space-y-1.5">
                                            <label className="text-xs font-bold text-slate-400 ml-1 uppercase">Liên kết (Link)</label>
                                            <div className="relative">
                                                <input className="w-full bg-slate-50 hover:bg-slate-100 focus:bg-white border border-transparent focus:border-blue-500 rounded-xl pl-10 pr-4 py-3 text-sm font-medium text-blue-600 transition-all outline-none" placeholder="https://..." value={inputData.link} onChange={e => setInputData({...inputData, link: e.target.value})} />
                                                <I n="vid" className="absolute left-3.5 top-3.5 text-slate-400" size={18}/>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="pt-4">
                                        <button onClick={addItem} className="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-black shadow-lg shadow-slate-200 hover:shadow-xl transition-all transform active:scale-[0.98]">Xác nhận thêm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <style>{`
                        .perspective-1000 { perspective: 1000px; }
                        .transform-style-3d { transform-style: preserve-3d; }
                        .backface-hidden { backface-visibility: hidden; }
                        .rotate-y-180 { transform: rotateY(180deg); }
                    `}</style>
                </div>
            );
        };

        // --- 2. COMPONENT: BÀI GIẢNG SỐ (V13.0 - FLASHCARD STATS) ---
        const LecturesView = ({ subjects, updateSubjects, isReadOnly }) => {
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            const allCourses = useMemo(() => {
                let list = [];
                if(typeof DATA_VAT_LY !== 'undefined') DATA_VAT_LY.forEach(sec => list.push(...sec.courses));
                if(typeof DATA_CNSH !== 'undefined') DATA_CNSH.forEach(sec => list.push(...sec.courses));
                return list;
            }, []);

            const filteredCourses = allCourses.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()) || c.code.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const handleSelectCourse = (course) => {
                if (isReadOnly) return;
                if (subjects.find(s => s.code === course.code)) return alert("Môn này đã có!");
                // Khởi tạo với flashcards: []
                updateSubjects([...subjects, { id: Date.now(), name: course.name, code: course.code, flashcards: [], materials: [], isPinned: false }]);
                setShowAddModal(false); setSearchTerm('');
            };

            const togglePin = (e, id) => { e.stopPropagation(); if (isReadOnly) return; updateSubjects(subjects.map(s => s.id === id ? { ...s, isPinned: !s.isPinned } : s)); };
            const handleDeleteSubject = (e, id) => { e.stopPropagation(); if (isReadOnly) return; if (confirm('Xóa môn này?')) updateSubjects(subjects.filter(s => s.id !== id)); };
            const sortedSubjects = [...subjects].sort((a, b) => (a.isPinned === b.isPinned ? 0 : a.isPinned ? -1 : 1));

            if (selectedSubject) return <SubjectDetail 
                subject={selectedSubject} 
                onBack={() => setSelectedSubject(null)} 
                isReadOnly={isReadOnly}
                showLinks={true}
                onUpdate={(updated) => { 
                    if (isReadOnly) return;
                    updateSubjects(subjects.map(s => s.id === updated.id ? updated : s));
                    setSelectedSubject(updated); 
                }} 
            />;

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto font-sans pb-32">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
                        <div><h1 className="text-3xl font-extrabold text-slate-800 tracking-tight mb-1">Thư viện bài giảng</h1><p className="text-slate-500 text-sm font-medium">Lưu trữ tài liệu và ôn tập Flashcards</p></div>
                        <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-slate-200 shadow-sm"><span className="font-bold text-slate-700">{subjects.length}</span><span className="text-slate-400 text-sm">môn học</span></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        {sortedSubjects.map(sub => (
                            <div key={sub.id} onClick={() => setSelectedSubject(sub)} className={`bg-white p-6 rounded-3xl border transition-all cursor-pointer group relative flex flex-col justify-between h-48 hover:-translate-y-1 hover:shadow-xl ${sub.isPinned ? 'border-amber-200 shadow-lg shadow-amber-50' : 'border-slate-100 shadow-sm hover:border-indigo-100'}`}>
                                <div>
                                    <div className="flex justify-between items-start mb-3"><span className={`text-[10px] font-mono font-bold px-2 py-1 rounded-lg uppercase tracking-wide ${sub.isPinned ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>{sub.code}</span>{!isReadOnly && (<button onClick={(e) => togglePin(e, sub.id)} className={`p-1.5 rounded-full transition-all ${sub.isPinned ? 'text-amber-400 bg-amber-50' : 'text-slate-200 hover:text-amber-400 hover:bg-slate-50'}`}><I n="grad" size={20}/></button>)}</div>
                                    <h3 className="font-bold text-slate-800 text-lg leading-tight line-clamp-2 mb-2 group-hover:text-indigo-600 transition-colors">{sub.name}</h3>
                                </div>
                                <div className="flex items-center gap-3 text-xs font-medium text-slate-400 pt-4 border-t border-slate-50">
                                    {/* HIỆN SỐ LƯỢNG THẺ FLASHCARDS */}
                                    <span className="flex items-center gap-1"><I n="atom" size={14}/> {sub.flashcards?.length || 0} thẻ</span>
                                    <span className="flex items-center gap-1"><I n="list" size={14}/> {sub.materials?.length || 0} doc</span>
                                    {!isReadOnly && (<button onClick={(e) => handleDeleteSubject(e, sub.id)} className="ml-auto p-1.5 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-full opacity-0 group-hover:opacity-100 transition-all"><I n="trash" size={16}/></button>)}
                                </div>
                            </div>
                        ))}
                        {!isReadOnly && (<button onClick={() => setShowAddModal(true)} className="h-48 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center justify-center text-slate-400 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all gap-2 group"><div className="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-white group-hover:shadow-md transition-all"><I n="plus" size={24}/></div><span className="font-bold text-sm">Thêm môn học</span></button>)}
                    </div>
                    {showAddModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-[24px] w-full max-w-md p-6 shadow-2xl animate-in zoom-in-95 duration-200 flex flex-col max-h-[80vh]">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-extrabold text-xl text-slate-800">Chọn môn học</h3><button onClick={() => setShowAddModal(false)} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><I n="x"/></button></div>
                                <div className="relative mb-4"><I n="list" className="absolute left-4 top-3.5 text-slate-400" size={18}/><input autoFocus className="w-full bg-slate-50 border border-slate-200 pl-11 pr-4 py-3 rounded-2xl text-sm focus:border-indigo-500 outline-none font-medium" placeholder="Nhập tên hoặc mã môn..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/></div>
                                <div className="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">{filteredCourses.map(c => (<button key={c.code} onClick={() => handleSelectCourse(c)} className="w-full text-left p-4 rounded-2xl hover:bg-indigo-50 border border-transparent hover:border-indigo-100 transition-all group"><div className="flex justify-between"><div className="font-bold text-slate-700 text-sm group-hover:text-indigo-700">{c.name}</div><div className="text-[10px] font-mono bg-slate-100 text-slate-500 px-2 py-0.5 rounded group-hover:bg-white">{c.code}</div></div><div className="text-xs text-slate-400 mt-1">{c.credits} tín chỉ</div></button>))}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 5. COMPONENT: DASHBOARD (ĐÃ SỬA: PHÒNG HỌC RÕ RÀNG & LOGIC ƯU TIÊN MỚI) ---
        const DashboardView = ({ user, courseData, statusMap, scoreMap, scheduleList, taskList, examSchedule, lectureSubjects, englishTopics, setActiveTab }) => {
            const [randomCard, setRandomCard] = useState(null);
            const [showAnswer, setShowAnswer] = useState(false);
            const [quote, setQuote] = useState({ text: "Học tập là hạt giống của kiến thức.", author: "Ngạn ngữ" });
            
            // STATE BỘ LỌC FLASHCARD
            const [showFilter, setShowFilter] = useState(false);
            const [sourceList, setSourceList] = useState([]);
            const [selectedSources, setSelectedSources] = useState(() => {
                const saved = localStorage.getItem('gwen_flashcard_filter');
                return saved ? JSON.parse(saved) : [];
            });

            // Danh ngôn
            const QUOTES = [
                { t: "Không có áp lực, không có kim cương.", a: "Thomas Carlyle" },
                { t: "Cách tốt nhất để dự đoán tương lai là tạo ra nó.", a: "Peter Drucker" },
                { t: "Giáo dục là vũ khí mạnh nhất để thay đổi thế giới.", a: "Nelson Mandela" }
            ];
            useEffect(() => { setQuote(QUOTES[Math.floor(Math.random() * QUOTES.length)]); }, []);

            // 1. TÍNH TOÁN CPA (Giữ nguyên)
            const stats = useMemo(() => {
                let studiedCredits = 0, totalScorePoints = 0, gpaCredits = 0;
                const dataToUse = courseData || [];
                dataToUse.forEach(s => { 
                    if (s.id === 'general_excluded') return; 
                    s.courses.forEach(c => {
                        if (statusMap[c.code] === 'studied') {
                            studiedCredits += c.credits;
                            const sc = scoreMap ? scoreMap[c.code] : undefined;
                            if (sc !== undefined && !isNaN(sc)) {
                                totalScorePoints += sc * c.credits;
                                gpaCredits += c.credits;
                            }
                        }
                    });
                });
                const cpa = gpaCredits > 0 ? (totalScorePoints / gpaCredits).toFixed(2) : "0.00";
                const totalTarget = dataToUse.reduce((acc, sec) => acc + (sec.id === 'general_excluded' ? 0 : sec.requiredCredits), 0);
                return { studiedCredits, cpa, totalTarget };
            }, [statusMap, scoreMap, courseData]);

            // 2. LỊCH TRÌNH HÔM NAY (GỘP THI & HỌC)
            const todaySchedule = useMemo(() => {
                const today = new Date();
                const days = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
                const currentDay = days[today.getDay()];
                // Tạo chuỗi ngày YYYY-MM-DD chuẩn theo múi giờ địa phương
                const dateStr = today.toLocaleDateString('en-CA'); 

                // Lớp học
                const classes = scheduleList.filter(c => c.day === currentDay).map(c => ({...c, type: 'class'}));
                
                // Lịch thi (BỎ dòng endTime: '...' đi)
                const exams = (examSchedule || []).filter(e => e.date === dateStr).map(e => ({
                    ...e, type: 'exam' 
                }));

                return [...classes, ...exams].sort((a, b) => a.time.localeCompare(b.time));
            }, [scheduleList, examSchedule]);

            // 3. NHIỆM VỤ CẦN LÀM (LOGIC MỚI: 1 TUẦN TỚI -> PRIORITY)
            const priorityTasks = useMemo(() => {
                const today = new Date();
                today.setHours(0,0,0,0);
                
                // Ngày giới hạn (7 ngày tới)
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);

                const toDateStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const todayStr = toDateStr(today);
                const nextWeekStr = toDateStr(nextWeek);

                // A. LỊCH THI TRONG 1 TUẦN TỚI (Trừ hôm nay ra vì đã hiện ở Lịch trình)
                const examsInWeek = (examSchedule || [])
                    .filter(e => e.date > todayStr && e.date <= nextWeekStr)
                    .map(e => ({ 
                        ...e, 
                        type: 'exam', 
                        label: 'Sắp thi',
                        displayDate: new Date(e.date).toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit'})
                    }))
                    .sort((a,b) => a.date.localeCompare(b.date));

                // B. NHIỆM VỤ
                const pendingTasks = (taskList || []).filter(t => !t.completed);
                
                // Phân loại task
                const tasksInWeek = [];
                const tasksOthers = [];

                pendingTasks.forEach(t => {
                    // Nếu có ngày hết hạn và nằm trong tuần này
                    if (t.dueDate && t.dueDate >= todayStr && t.dueDate <= nextWeekStr) {
                        tasksInWeek.push(t);
                    } else {
                        tasksOthers.push(t);
                    }
                });

                // Helper: Sắp xếp theo Priority (High -> Medium -> Low)
                const pOrder = { high: 0, medium: 1, low: 2 };
                const sortByPriority = (a, b) => (pOrder[a.priority] || 2) - (pOrder[b.priority] || 2);

                // 1. Sắp xếp task tuần: Theo Priority trước -> rồi đến Ngày
                tasksInWeek.sort((a, b) => {
                    const pDiff = sortByPriority(a, b);
                    if (pDiff !== 0) return pDiff;
                    return a.dueDate.localeCompare(b.dueDate);
                });

                // 2. Sắp xếp task khác: Chỉ theo Priority
                tasksOthers.sort(sortByPriority);

                const fmtTask = (t) => ({
                    ...t, 
                    type: 'task', 
                    label: t.dueDate === todayStr ? 'Hạn hôm nay' : (pOrder[t.priority]===0 ? 'Ưu tiên cao' : (t.dueDate ? 'Sắp tới' : 'Nhiệm vụ')),
                    displayDate: t.dueDate ? new Date(t.dueDate).toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit'}) : ''
                });

                // GỘP TẤT CẢ THEO THỨ TỰ ƯU TIÊN
                const final = [
                    ...examsInWeek,
                    ...tasksInWeek.map(fmtTask),
                    ...tasksOthers.map(fmtTask)
                ];

                return final.slice(0, 3); // Lấy tối đa 3 cái
            }, [examSchedule, taskList]);

            // 4. FLASHCARD (Giữ nguyên)
            useEffect(() => {
                const allCards = [];
                const sources = new Set();
                (lectureSubjects || []).forEach(sub => { if (sub.flashcards) { sub.flashcards.forEach(c => allCards.push({...c, source: sub.name})); sources.add(sub.name); }});
                (englishTopics || []).forEach(topic => { if (topic.flashcards) { topic.flashcards.forEach(c => allCards.push({...c, source: topic.name})); sources.add(topic.name); }});
                
                const uniqueSources = Array.from(sources);
                if (JSON.stringify(uniqueSources) !== JSON.stringify(sourceList)) {
                    setSourceList(uniqueSources);
                    if (!localStorage.getItem('gwen_flashcard_filter')) setSelectedSources(uniqueSources);
                }
                
                const activeSources = selectedSources.length > 0 ? selectedSources : (localStorage.getItem('gwen_flashcard_filter') ? [] : uniqueSources);
                const filtered = allCards.filter(c => activeSources.includes(c.source));
                if (filtered.length > 0) setRandomCard(filtered[Math.floor(Math.random() * filtered.length)]);
                else setRandomCard(null);
            }, [lectureSubjects, englishTopics, selectedSources, showFilter]);

            const toggleSource = (src) => {
                let newSelection = selectedSources.includes(src) ? selectedSources.filter(s => s !== src) : [...selectedSources, src];
                setSelectedSources(newSelection);
                localStorage.setItem('gwen_flashcard_filter', JSON.stringify(newSelection));
            };

            const RenderMath = ({ text }) => {
                if (!text) return null;
                return <span>{text.split(/(\$[^\$]+\$)/g).map((p,i) => {
                    if (p.startsWith('$') && p.endsWith('$')) {
                        try { return <span key={i} dangerouslySetInnerHTML={{__html: window.katex.renderToString(p.slice(1,-1), {throwOnError:false})}} className="text-indigo-700 font-bold bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 mx-1 inline-block"/>; } catch(e) { return p; }
                    } return p;
                })}</span>;
            };

            return (
                <div className="pb-24 p-4 md:p-8 max-w-7xl mx-auto font-sans">
                    {/* Header */}
                    <div className="mb-10 bg-gradient-to-r from-slate-900 to-slate-800 rounded-3xl p-8 text-white shadow-xl shadow-slate-200 relative overflow-hidden">
                        <div className="relative z-10">
                            <div className="text-indigo-300 font-bold uppercase tracking-widest text-xs mb-2">{new Date().toLocaleDateString('vi-VN', {weekday: 'long', day: 'numeric', month: 'long'})}</div>
                            <h1 className="text-3xl font-extrabold mb-2">Xin chào, {user?.displayName?.split(' ').pop() || 'Bạn'}! 👋</h1>
                            <p className="text-slate-400 text-sm max-w-lg">"{quote.t}" - {quote.a}</p>
                        </div>
                        <div className="absolute right-0 top-0 w-64 h-64 bg-indigo-500 rounded-full blur-[80px] opacity-20 -mr-16 -mt-16"></div>
                    </div>

                    {/* Stats Widget */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-5 hover:shadow-md transition-shadow"><div className="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><I n="grad" size={28}/></div><div><div className="text-3xl font-black text-slate-800 tracking-tight">{stats.cpa}</div><div className="text-xs font-bold text-slate-400 uppercase tracking-wide">CPA hiện tại</div></div></div>
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-5 hover:shadow-md transition-shadow"><div className="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center"><I n="book" size={28}/></div><div><div className="text-3xl font-black text-slate-800 tracking-tight">{stats.studiedCredits}</div><div className="text-xs font-bold text-slate-400 uppercase tracking-wide">Tín chỉ tích lũy</div></div></div>
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-center hover:shadow-md transition-shadow"><div className="flex justify-between items-end mb-2"><div className="text-xs font-bold text-slate-400 uppercase">Tiến độ</div><div className="text-xl font-black text-slate-800">{Math.round((stats.studiedCredits/stats.totalTarget)*100) || 0}%</div></div><div className="w-full bg-slate-100 rounded-full h-2 overflow-hidden"><div className="bg-slate-800 h-full transition-all duration-1000" style={{width: `${(stats.studiedCredits/stats.totalTarget)*100}%`}}></div></div></div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* CỘT TRÁI: Lịch & Task */}
                        <div className="lg:col-span-2 space-y-8">
                            
                            {/* --- LỊCH TRÌNH (BAO GỒM CẢ THI) --- */}
                            <div className="bg-white rounded-[32px] p-8 border border-slate-100 shadow-sm">
                                <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-3 text-lg"><div className="w-10 h-10 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center flex-shrink-0"><I n="cal" size={20}/></div>Lịch trình hôm nay</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {todaySchedule.length > 0 ? todaySchedule.map(c => (
                                        <div key={c.id} className={`p-4 border rounded-2xl flex flex-col justify-between hover:shadow-md transition-all group ${c.type === 'exam' ? 'bg-rose-50 border-rose-100' : 'bg-slate-50 border-slate-100 hover:bg-white'}`}>
                                            <div>
                                                <div className="flex justify-between mb-2">
                                                    <span className={`text-xs font-bold px-2 py-1 rounded-lg ${c.type === 'exam' ? 'text-rose-600 bg-rose-100' : 'text-indigo-600 bg-indigo-50'}`}>
                                                        {c.time} {c.endTime ? '- ' + c.endTime : ''} {c.type === 'exam' && '• THI'}
                                                    </span>
                                                    {/* GIAO DIỆN PHÒNG HỌC MỚI: TO, RÕ, ĐÓNG KHUNG */}
                                                    <span className="text-xs font-extrabold text-indigo-700 bg-indigo-50 border border-indigo-200 px-2.5 py-1 rounded-lg shadow-sm flex items-center gap-1.5">
                                                        <I n="grad" size={14}/> {c.room}
                                                    </span>
                                                </div>
                                                <div className={`font-bold text-lg leading-snug ${c.type === 'exam' ? 'text-rose-800' : 'text-slate-800'}`}>{c.subject}</div>
                                            </div>
                                        </div>
                                    )) : <div className="col-span-full py-8 text-center text-slate-400 italic bg-slate-50/50 rounded-2xl border-2 border-dashed border-slate-100">Hôm nay không có lịch học & thi.</div>}
                                </div>
                            </div>

                            {/* --- TASK (ĐÃ SỬA LOGIC ƯU TIÊN) --- */}
                            <div className="bg-white rounded-[32px] p-8 border border-slate-100 shadow-sm">
                                <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-3 text-lg"><div className="w-10 h-10 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center flex-shrink-0"><I n="list" size={20}/></div>To-do-list</h3>
                                <div className="space-y-3">
                                    {priorityTasks.length > 0 ? priorityTasks.map((t, idx) => (
                                        <div key={idx} className={`p-4 rounded-2xl border flex items-center gap-4 transition-all hover:translate-x-1 ${t.type === 'exam' ? 'bg-rose-50 border-rose-200' : 'bg-white border-slate-200'}`}>
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${t.type === 'exam' ? 'bg-rose-100 text-rose-600' : 'bg-amber-100 text-amber-600'}`}>
                                                <I n={t.type === 'exam' ? 'clock' : 'check'} size={20}/>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-0.5">
                                                    <span className={`text-[9px] font-extrabold px-2 py-0.5 rounded uppercase tracking-wide ${t.type === 'exam' ? 'bg-rose-500 text-white' : 'bg-slate-800 text-white'}`}>{t.label}</span>
                                                    {t.displayDate && <span className="text-xs text-slate-500 font-mono font-bold">{t.displayDate}</span>}
                                                </div>
                                                <div className="font-bold text-slate-800 truncate">{t.subject || t.title}</div>
                                            </div>
                                        </div>
                                    )) : <div className="py-8 text-center text-slate-400 italic bg-slate-50/50 rounded-2xl border-2 border-dashed border-slate-100">Không có nhiệm vụ gấp.</div>}
                                </div>
                            </div>
                        </div>

                        {/* CỘT PHẢI: Flashcard */}
                        <div className="bg-slate-900 rounded-[40px] p-8 text-white shadow-2xl shadow-slate-300 relative overflow-hidden flex flex-col min-h-[400px] group">
                            <div className="absolute top-0 right-0 w-48 h-48 bg-purple-500 rounded-full blur-[100px] opacity-40 group-hover:opacity-60 transition-opacity"></div>
                            <div className="absolute bottom-0 left-0 w-48 h-48 bg-indigo-500 rounded-full blur-[100px] opacity-40 group-hover:opacity-60 transition-opacity"></div>
                            <div className="flex justify-between items-center mb-8 relative z-10"><h3 className="font-bold flex items-center gap-2"><I n="atom" className="text-purple-400"/> Flashcards</h3><button onClick={() => setShowFilter(true)} className="w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full transition-all text-white backdrop-blur-sm" title="Chọn môn học"><I n="settings" size={20}/></button></div>
                            {randomCard ? (<div className="flex-1 flex flex-col relative z-10"><div className="flex-1 flex items-center justify-center text-center"><div className="text-xl font-bold leading-relaxed"><RenderMath text={showAnswer ? randomCard.content : randomCard.title} /></div></div><div className="pt-8 border-t border-white/10 text-center"><p className="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{showAnswer ? "ĐÁP ÁN" : "CÂU HỎI"} • {randomCard.source}</p><button onClick={() => setShowAnswer(!showAnswer)} className="w-full py-4 rounded-2xl bg-white text-slate-900 font-bold hover:scale-105 transition-transform active:scale-95 shadow-lg">{showAnswer ? "Xem câu hỏi" : "Xem đáp án"}</button></div></div>) : (<div className="flex-1 flex flex-col items-center justify-center text-slate-500 relative z-10 text-center"><I n="book" size={40} className="mb-4 opacity-30"/><span className="text-sm">Chưa có Flashcard nào.<br/>Hoặc bạn đã lọc hết môn học.</span></div>)}
                        </div>
                    </div>

                    {/* MODAL LỌC */}
                    {showFilter && (<div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 flex items-center justify-center p-4"><div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-in zoom-in-95"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl text-slate-800">Nguồn thẻ</h3><button onClick={() => setShowFilter(false)} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><I n="x" size={20}/></button></div><div className="max-h-[50vh] overflow-y-auto custom-scrollbar space-y-3 mb-6">{sourceList.map(src => (<div key={src} onClick={() => toggleSource(src)} className={`flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${selectedSources.includes(src) ? 'bg-indigo-50 border-indigo-500 shadow-sm' : 'bg-white border-slate-100 hover:bg-slate-50'}`}><span className={`text-sm font-bold ${selectedSources.includes(src) ? 'text-indigo-700' : 'text-slate-600'}`}>{src}</span>{selectedSources.includes(src) && <div className="w-6 h-6 bg-indigo-500 rounded-full flex items-center justify-center text-white shadow-sm"><I n="check" size={14}/></div>}</div>))}{sourceList.length === 0 && <div className="text-center text-slate-400 py-4">Chưa có môn nào có Flashcard.</div>}</div><button onClick={() => setShowFilter(false)} className="w-full py-4 rounded-2xl bg-slate-900 text-white font-bold shadow-lg hover:bg-black transition-colors">Hoàn tất</button></div></div>)}
                </div>
            );
        };   



        // --- 3. COMPONENT: TIẾNG ANH (V13.0 - FLASHCARD STATS) ---
        const EnglishView = ({ topics, updateTopics, isReadOnly }) => {
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [newTopicName, setNewTopicName] = useState('');

            const getTopicColor = (name) => {
                const colors = [{ bg: 'bg-orange-100', text: 'text-orange-600' }, { bg: 'bg-blue-100', text: 'text-blue-600' }, { bg: 'bg-emerald-100', text: 'text-emerald-600' }, { bg: 'bg-rose-100', text: 'text-rose-600' }, { bg: 'bg-violet-100', text: 'text-violet-600' }];
                let hash = 0;
                for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
                return colors[Math.abs(hash) % colors.length];
            };

            const handleAddTopic = () => {
                if (isReadOnly) return;
                if (!newTopicName.trim()) return alert("Nhập tên chủ đề!");
                // Khởi tạo với flashcards: []
                updateTopics([...topics, { id: Date.now(), name: newTopicName, flashcards: [], materials: [] }]);
                setNewTopicName(''); setShowModal(false);
            };

            const handleDeleteTopic = (e, id) => {
                e.stopPropagation(); if (isReadOnly) return;
                if (confirm('Xóa chủ đề này?')) updateTopics(topics.filter(t => t.id !== id));
            };

            if (selectedTopic) return <SubjectDetail 
                subject={selectedTopic} 
                onBack={() => setSelectedTopic(null)} 
                isReadOnly={isReadOnly}
                showLinks={true} 
                onUpdate={(updated) => { 
                    if(isReadOnly) return;
                    updateTopics(topics.map(t => t.id === updated.id ? updated : t)); 
                    setSelectedTopic(updated); 
                }} 
            />;

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto font-sans pb-32">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
                        <div><h1 className="text-3xl font-extrabold text-slate-800 tracking-tight mb-1">Tài liệu tiếng anh</h1><p className="text-slate-500 text-sm font-medium">Kho tài liệu và từ vựng (Flashcards)</p></div>
                        <div className="bg-white px-4 py-2 rounded-full border border-slate-200 shadow-sm flex items-center gap-2"><span className="font-bold text-slate-800 text-lg">{topics.length}</span><span className="text-slate-400 text-sm">chủ đề</span></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        {topics.map(t => {
                            const color = getTopicColor(t.name);
                            return (
                                <div key={t.id} onClick={() => setSelectedTopic(t)} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)] hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group relative overflow-hidden">
                                    <div className="flex justify-between items-start mb-4 relative z-10">
                                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl font-bold ${color.bg} ${color.text} shadow-inner`}>{t.name.charAt(0).toUpperCase()}</div>
                                        {!isReadOnly && (<button onClick={(e) => handleDeleteTopic(e, t.id)} className="p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-all opacity-0 group-hover:opacity-100"><I n="trash" size={20}/></button>)}
                                    </div>
                                    <div className="relative z-10">
                                        <h3 className="font-bold text-xl text-slate-800 mb-1 group-hover:text-indigo-600 transition-colors line-clamp-1">{t.name}</h3>
                                        <div className="flex items-center gap-4 text-xs font-medium text-slate-400 mt-3">
                                            {/* HIỆN THÔNG SỐ FLASHCARDS & TÀI LIỆU */}
                                            <span className="flex items-center gap-1.5"><I n="atom" size={14}/> {t.flashcards?.length || 0} thẻ</span>
                                            <span className="flex items-center gap-1.5"><I n="list" size={14}/> {t.materials?.length || 0} doc</span>
                                        </div>
                                    </div>
                                    <div className={`absolute -bottom-6 -right-6 w-24 h-24 rounded-full ${color.bg} opacity-50 group-hover:scale-150 transition-transform duration-500`}></div>
                                </div>
                            )
                        })}
                        {!isReadOnly && (<button onClick={() => setShowModal(true)} className="h-48 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center justify-center text-slate-400 hover:border-orange-300 hover:text-orange-500 hover:bg-orange-50/50 transition-all gap-3 group"><div className="w-14 h-14 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-white group-hover:shadow-md transition-all text-slate-400 group-hover:text-orange-500"><I n="plus" size={28}/></div><span className="font-bold text-sm">Tạo chủ đề mới</span></button>)}
                    </div>
                    {showModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-[24px] w-full max-w-sm p-6 shadow-2xl animate-in zoom-in-95 duration-200">
                                <h3 className="font-extrabold text-xl mb-6 text-slate-800">Chủ đề mới</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block uppercase">Tên chủ đề</label><input autoFocus className="w-full bg-slate-50 border border-slate-200 p-4 rounded-2xl text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none font-bold text-slate-700" placeholder="VD: IELTS Writing..." value={newTopicName} onChange={e => setNewTopicName(e.target.value)}/></div>
                                    <div className="flex justify-end gap-3 pt-2"><button onClick={() => setShowModal(false)} className="px-6 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors">Hủy</button><button onClick={handleAddTopic} className="px-6 py-3 bg-orange-500 text-white rounded-xl font-bold hover:bg-orange-600 shadow-lg shadow-orange-200 transition-all">Tạo ngay</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        

        // --- COMPONENT: QUẢN LÝ THÀNH VIÊN (ADMIN ONLY) ---
        const UserManagerView = ({ isReadOnly }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!window.DB_TOOLS) return;
                const { db, onSnapshot, collection } = window.DB_TOOLS;
                
                // Lấy danh sách từ collection 'all_users'
                // Lưu ý: Cần dùng collection() thay vì doc()
                // Do chúng ta dùng bản module, cần import collection ở bước 3 nếu chưa có.
                // Ở đây tôi dùng cách lấy trực tiếp qua db
                
                // Hack nhẹ: Để đơn giản hóa trong mô hình hiện tại, ta sẽ query collection thủ công
                // Vì trong module script ở dưới tôi sẽ update thêm hàm collection
                
                // Giả sử window.DB_TOOLS đã có collection (sẽ update ở bước 3)
                if (window.DB_TOOLS.collection) {
                    const unsub = onSnapshot(window.DB_TOOLS.collection(db, "all_users"), (snap) => {
                        const list = [];
                        snap.forEach(doc => list.push(doc.data()));
                        // Sắp xếp theo thời gian đăng nhập gần nhất
                        list.sort((a, b) => new Date(b.lastLogin) - new Date(a.lastLogin));
                        setUsers(list);
                        setLoading(false);
                    });
                    return () => unsub();
                }
            }, []);

            if (loading) return <div className="p-8 text-center text-slate-400">Đang tải danh sách...</div>;

            return (
                <div className="p-4 md:p-8 max-w-5xl mx-auto font-sans pb-32">
                    <div className="mb-8">
                        <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight mb-1">Thành viên</h1>
                        <p className="text-slate-500 text-sm font-medium">Danh sách những người đã đăng nhập vào hệ thống</p>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-3xl shadow-sm overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="bg-slate-50 border-b border-slate-100 text-xs uppercase text-slate-500 font-bold tracking-wider">
                                        <th className="p-5">Thành viên</th>
                                        <th className="p-5">Email</th>
                                        <th className="p-5">Đăng nhập lần cuối</th>
                                        <th className="p-5 text-right">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {users.map((u, idx) => (
                                        <tr key={idx} className="hover:bg-slate-50/50 transition-colors group">
                                            <td className="p-5">
                                                <div className="flex items-center gap-3">
                                                    <img src={u.photoURL} className="w-10 h-10 rounded-full border border-slate-200" />
                                                    <span className="font-bold text-slate-700 text-sm">{u.displayName}</span>
                                                </div>
                                            </td>
                                            <td className="p-5 text-sm text-slate-600 font-medium font-mono">{u.email}</td>
                                            <td className="p-5 text-sm text-slate-500">
                                                {new Date(u.lastLogin).toLocaleString('vi-VN')}
                                            </td>
                                            <td className="p-5 text-right">
                                                <span className="inline-block w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {users.length === 0 && <div className="p-8 text-center text-slate-400">Chưa có ai đăng nhập ngoài bạn.</div>}
                    </div>
                </div>
            );
        };        



        // --- 6. APP CHÍNH (ĐÃ THÊM LOGIC ẨN DASHBOARD) ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [user, setUser] = useState(null);
            
            const ADMIN_EMAILS = ["gwengx22@gmail.com", "luuquyen376@gmail.com", "duahaumvp@gmail.com"]; 
            const isAdmin = user && ADMIN_EMAILS.includes(user.email);
            const isReadOnly = !isAdmin;

            const [currentMajor, setCurrentMajor] = useState('vat_ly'); 
            const [dbData, setDbData] = useState({});

            // CẤU HÌNH TAB (ẨN DASHBOARD NẾU KHÔNG PHẢI ADMIN)
            const allTabs = [
                {id:'dashboard', l:'Bảng tin', i:'grid'},
                {id:'courses', l:'Tiến độ', i:'grad'},
                {id:'schedule', l:'Lịch trình', i:'cal'}, 
                {id:'lectures', l:'Bài giảng số', i:'vid'},
                {id:'english', l:'Tiếng Anh', i:'eng'},
                {id:'activities', l:'Ngoại khóa', i:'act'},
            ];
            
            if (isAdmin) allTabs.push({id: 'users', l: 'Thành viên', i: 'list'});

            // LOGIC QUAN TRỌNG: Lọc tab hiển thị
            const visibleTabs = isAdmin ? allTabs : allTabs.filter(t => ['lectures', 'english', 'activities'].includes(t.id));

            // Tự động chuyển hướng nếu đang ở tab bị cấm
            useEffect(() => {
                if (!user) return;
                const isAllowed = visibleTabs.find(t => t.id === activeTab);
                if (!isAllowed) setActiveTab(visibleTabs[0]?.id || 'lectures');
            }, [user, isAdmin, activeTab]);

            useEffect(() => {
                if (user) setCurrentMajor(user.email.includes('luuquyen376') ? 'cnsh' : 'vat_ly');
            }, [user]);

            const activeCourseData = useMemo(() => currentMajor === 'cnsh' ? DATA_CNSH : DATA_VAT_LY, [currentMajor]);

            const [statusMap, setStatusMap] = useState({});
            const [scoreMap, setScoreMap] = useState({});
            const [scheduleList, setScheduleList] = useState([]);
            const [taskList, setTaskList] = useState([]);
            const [timetableData, setTimetableData] = useState({});
            const [examSchedule, setExamSchedule] = useState([]);
            const [lectureSubjects, setLectureSubjects] = useState([]);
            const [englishTopics, setEnglishTopics] = useState([]);

            useEffect(() => { if(window.AUTH_SUBSCRIBE) window.AUTH_SUBSCRIBE(setUser); }, []);
            
            useEffect(() => {
                if (user && window.DB_TOOLS) {
                    const { db, doc, setDoc } = window.DB_TOOLS;
                    const userRecordRef = doc(db, "all_users", user.email);
                    setDoc(userRecordRef, {
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        lastLogin: new Date().toISOString()
                    }, { merge: true });
                }
            }, [user]);

            useEffect(() => {
                let unsub;
                if (user && window.DB_TOOLS) {
                    const { db, doc, onSnapshot, setDoc } = window.DB_TOOLS;
                    const docRef = doc(db, "data", currentMajor);
                    unsub = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setStatusMap(data.statusMap || {});
                            setScoreMap(data.scoreMap || {});
                            setScheduleList(data.scheduleList || []);
                            setTaskList(data.taskList || []);
                            setTimetableData(data.timetableData || {});
                            setExamSchedule(data.examSchedule || []);
                            setLectureSubjects(data.lectureSubjects || []);
                            setEnglishTopics(data.englishTopics || []);
                        } else if (isAdmin) {
                            setDoc(docRef, { created: Date.now() }, { merge: true });
                        }
                    });
                }
                return () => unsub && unsub();
            }, [user, currentMajor]);

            // --- HÀM CẬP NHẬT DB (ĐÃ SỬA: DÙNG UPDATE DOC ĐỂ GHI ĐÈ CHÍNH XÁC) ---
            const updateCloud = (key, data, setter) => {
                setter(data); 
                if (user && window.DB_TOOLS && !isReadOnly) {
                    const { db, doc, updateDoc, setDoc } = window.DB_TOOLS;
                    const docRef = doc(db, "data", currentMajor);
                    
                    // QUAN TRỌNG: Dùng updateDoc để thay thế hoàn toàn field (giúp xóa được key)
                    // Nếu dùng setDoc(..., {merge: true}) thì key cũ vẫn còn.
                    updateDoc(docRef, { [key]: data }).catch(() => {
                        // Phòng trường hợp doc chưa tồn tại thì mới dùng setDoc tạo mới
                        setDoc(docRef, { [key]: data }, { merge: true });
                    });
                }
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 p-6 text-center">
                        <div className="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white shadow-2xl shadow-indigo-200 mb-6"><I n="grad" size={40}/></div>
                        <h1 className="text-3xl font-extrabold text-slate-900 mb-2">Gwen Planner</h1>
                        <p className="text-slate-500 max-w-md mb-8">Hệ thống quản lý học tập. Đăng nhập để tiếp tục.</p>
                        <button onClick={() => window.LOGIN_GOOGLE()} className="bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:scale-105 transition-transform flex items-center gap-3">
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27 3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12.5S6.42 23 12.1 23c5.83 0 8.8-3.98 8.8-10.24 0-.68-.17-1.66-.17-1.66h.62z"/></svg> Đăng nhập Google
                        </button>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-[#F8FAFC] font-sans">
                    <aside className="hidden md:flex flex-col w-72 bg-white border-r border-slate-100 p-6 h-screen sticky top-0">
                        <div className="flex items-center gap-3 mb-8 px-2">
                            <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg shadow-slate-200">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M7 7 L17 7 L17 17 L7 17 Z M7 17 L7 21 M17 17 L17 21" strokeOpacity="0"/><path d="M4 12 a8 8 0 0 1 8 -8 h1 a8 8 0 0 1 8 8 v2 a8 8 0 0 1 -8 8 h-1 a8 8 0 0 1 -8 -8 v-2" /><path d="M12 12 l4 0" /></svg>
                            </div>
                            <div>
                                <h1 className="text-lg font-extrabold text-slate-900 leading-none tracking-tight">Gwen Planner</h1>
                                <span className="text-[10px] text-slate-400 font-bold tracking-widest uppercase">A tiny workspace</span>
                            </div>
                        </div>
                        <div className="mb-6 mx-2 p-1">
                            <div className="flex items-center gap-3 p-3 rounded-2xl bg-slate-50 border border-slate-100 mb-4">
                                <img src={user.photoURL} className="w-9 h-9 rounded-full border-2 border-white shadow-sm" />
                                <div className="flex-1 min-w-0"><div className="text-xs font-bold text-slate-700 truncate">{user.displayName}</div><button onClick={() => window.LOGOUT()} className="text-[10px] text-red-500 font-bold hover:underline">Đăng xuất</button></div>
                            </div>
                            {isAdmin && (
                                <div className="mb-2">
                                    <div className="text-[10px] font-extrabold text-slate-400 uppercase tracking-wider mb-2 ml-1">Khu vực làm việc</div>
                                    <div className="flex p-1 bg-slate-100 rounded-xl border border-slate-200">
                                        <button onClick={() => setCurrentMajor('vat_ly')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${currentMajor === 'vat_ly' ? 'bg-white text-indigo-600 shadow-sm border border-slate-100' : 'text-slate-400 hover:text-slate-600'}`}><I n="atom" size={16}/> Vật lý</button>
                                        <button onClick={() => setCurrentMajor('cnsh')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${currentMajor === 'cnsh' ? 'bg-white text-emerald-600 shadow-sm border border-slate-100' : 'text-slate-400 hover:text-slate-600'}`}><I n="dna" size={16}/> Sinh học</button>
                                    </div>
                                </div>
                            )}
                        </div>
                        <nav className="space-y-2 flex-1 mt-2">
                            {visibleTabs.map(m => (
                                <button key={m.id} onClick={() => setActiveTab(m.id)} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-medium transition-all duration-200 ${activeTab === m.id ? 'bg-slate-900 text-white shadow-md shadow-slate-300' : 'text-slate-500 hover:bg-slate-100 hover:text-slate-900'}`}>
                                    <I n={m.i} size={20} className={activeTab === m.id ? "text-white" : "text-slate-400"}/> {m.l}
                                </button>
                            ))}
                        </nav>
                    </aside>

                    <main className="flex-1 h-screen overflow-y-auto md:custom-scrollbar relative">
                        <div className="md:hidden"><UserHeader user={user} isAdmin={isAdmin} currentMajor={currentMajor} setCurrentMajor={setCurrentMajor} /></div>

                        {/* Chỉ hiện Dashboard nếu là Admin */}
                        {activeTab === 'dashboard' && isAdmin && <DashboardView user={user} courseData={activeCourseData} statusMap={statusMap} scoreMap={scoreMap} scheduleList={scheduleList} taskList={taskList} examSchedule={examSchedule} lectureSubjects={lectureSubjects} englishTopics={englishTopics} setActiveTab={setActiveTab} />}
                        
                        {activeTab === 'schedule' && isAdmin && <ScheduleView scheduleList={scheduleList} updateScheduleList={(d) => updateCloud('scheduleList', d, setScheduleList)} taskList={taskList} updateTaskList={(d) => updateCloud('taskList', d, setTaskList)} timetableData={timetableData} updateTimetableData={(d) => updateCloud('timetableData', d, setTimetableData)} examSchedule={examSchedule} updateExamSchedule={(d) => updateCloud('examSchedule', d, setExamSchedule)} isReadOnly={false} />}
                        {activeTab === 'courses' && isAdmin && <TrackerView courseData={activeCourseData} statusMap={statusMap} updateStatusMap={(d) => updateCloud('statusMap', d, setStatusMap)} scoreMap={scoreMap} updateScoreMap={(d) => updateCloud('scoreMap', d, setScoreMap)} isReadOnly={false} />}
                        {activeTab === 'lectures' && <LecturesView subjects={lectureSubjects} updateSubjects={(d) => updateCloud('lectureSubjects', d, setLectureSubjects)} isReadOnly={isReadOnly} />}
                        {activeTab === 'english' && <EnglishView topics={englishTopics} updateTopics={(d) => updateCloud('englishTopics', d, setEnglishTopics)} isReadOnly={isReadOnly} />}
                        {activeTab === 'users' && isAdmin && <UserManagerView />}
                        {activeTab === 'activities' && <PlaceholderView title="Hoạt động ngoại khóa" icon="act" />}
                    </main>

                    <div className="md:hidden fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 flex justify-around p-2 pb-safe z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">{visibleTabs.slice(0, 5).map(m => (<button key={m.id} onClick={() => setActiveTab(m.id)} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === m.id ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}`}><I n={m.i} size={20}/></button>))}</div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>