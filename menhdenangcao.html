<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thử Thách Mệnh Đề Quan Hệ (Hard Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Tối ưu font chữ cho di động */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #1e293b; /* Dark theme background */
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animation cho đúng/sai */
        .correct-anim { animation: pulse 0.5s; background-color: #065f46 !important; border-color: #34d399 !important; color: white !important; }
        .wrong-anim { animation: shake 0.4s; background-color: #7f1d1d !important; border-color: #f87171 !important; color: white !important; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        .question-text { font-size: 1.125rem; line-height: 1.6; }
        @media (min-width: 640px) {
            .question-text { font-size: 1.25rem; }
        }
        
        .option-item:active { transform: scale(0.98); }
        
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-3 sm:p-4">

    <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[95vh] border border-slate-700" id="app">
        
        <!-- Header -->
        <div class="bg-rose-700 p-4 sm:p-6 text-white text-center shadow-md z-10 shrink-0">
            <h1 class="text-xl sm:text-3xl font-bold mb-1 uppercase tracking-wider">Hard Mode Challenge</h1>
            <div class="flex items-center justify-center space-x-2">
                <p class="text-rose-100 text-xs sm:text-sm">70% Nâng Cao - 30% Cơ Bản</p>
                <span class="bg-rose-900 text-xs px-2 py-0.5 rounded text-white border border-rose-500"><i class="fas fa-random mr-1"></i>Random</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-slate-700 h-1.5 shrink-0">
            <div class="bg-emerald-500 h-1.5 transition-all duration-300" id="progress-bar" style="width: 0%"></div>
        </div>

        <!-- Scrollable Content Area -->
        <div class="flex-grow overflow-y-auto">
            
            <!-- Start Screen -->
            <div id="start-screen" class="p-6 sm:p-10 text-center fade-in flex flex-col items-center justify-center min-h-[400px]">
                <div class="mb-6 text-rose-500 text-6xl sm:text-7xl animate-pulse">
                    <i class="fas fa-dumbbell"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-bold mb-3 text-white">Sẵn sàng "hack não"?</h2>
                <div class="text-left bg-slate-700 p-4 rounded-lg border border-slate-600 mb-8 w-full shadow-inner text-sm sm:text-base">
                    <p class="text-slate-300 mb-2 font-semibold">Nội dung nâng cao bao gồm:</p>
                    <ul class="text-slate-300 space-y-1 list-disc pl-5">
                        <li>Đảo ngữ giới từ (of which, to whom, by which...)</li>
                        <li>Rút gọn mệnh đề phức tạp</li>
                        <li>Phân biệt What vs That vs Which</li>
                        <li>Lượng từ (all of whom, neither of which...)</li>
                    </ul>
                </div>
                <button onclick="startQuiz()" class="w-full sm:w-auto bg-rose-600 hover:bg-rose-700 text-white font-bold py-3.5 px-10 rounded-xl transition transform active:scale-95 shadow-lg flex items-center justify-center text-lg border-b-4 border-rose-800">
                    <i class="fas fa-play mr-2"></i> Bắt đầu ngay
                </button>
            </div>

            <!-- Quiz Container -->
            <div id="quiz-container" class="hidden p-4 sm:p-8 fade-in flex flex-col pb-20">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <span class="text-xs sm:text-sm font-bold text-rose-300 bg-rose-900/50 px-3 py-1 rounded-full border border-rose-800" id="question-counter">Câu 1/50</span>
                    <span class="text-xs sm:text-sm font-bold text-slate-400" id="score-display">Điểm: 0</span>
                </div>

                <div class="mb-4 sm:mb-6">
                    <h3 class="question-text font-semibold text-white mb-4 sm:mb-6 leading-relaxed" id="question-text">
                        <!-- Question goes here -->
                    </h3>
                
                    <div class="grid grid-cols-1 gap-3 sm:gap-4" id="options-container">
                        <!-- Options go here -->
                    </div>
                </div>

                <!-- Explanation Box -->
                <div id="explanation-box" class="hidden mb-6 p-4 bg-slate-700 border-l-4 border-amber-500 rounded-r-lg fade-in shadow-lg text-sm sm:text-base">
                    <p class="font-bold text-amber-400 mb-1 flex items-center"><i class="fas fa-lightbulb mr-2"></i>Giải thích chi tiết:</p>
                    <p class="text-slate-200 leading-relaxed" id="explanation-text"></p>
                </div>

                <!-- Next Button -->
                <div class="mt-4 hidden" id="next-btn-container">
                    <button onclick="nextQuestion()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 px-6 rounded-xl transition shadow-md flex items-center justify-center text-lg active:bg-emerald-800 border-b-4 border-emerald-800">
                        Câu tiếp theo <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden p-6 sm:p-10 text-center fade-in min-h-[400px] flex flex-col items-center justify-center">
                <div class="mb-4 sm:mb-6 text-6xl sm:text-7xl" id="result-icon"></div>
                <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-white" id="result-title"></h2>
                <p class="text-slate-400 mb-8 text-base sm:text-lg px-2" id="result-message"></p>
                
                <div class="flex justify-center items-center mb-8 space-x-4 w-full">
                    <div class="flex-1 text-center p-4 bg-slate-700 rounded-xl border border-slate-600">
                        <span class="block text-2xl sm:text-4xl font-bold text-rose-400 mb-1" id="final-score"></span>
                        <span class="text-[10px] sm:text-xs text-slate-400 uppercase tracking-wide font-bold">Điểm số</span>
                    </div>
                    <div class="flex-1 text-center p-4 bg-slate-700 rounded-xl border border-slate-600">
                        <span class="block text-2xl sm:text-4xl font-bold text-emerald-400 mb-1" id="final-percent"></span>
                        <span class="text-[10px] sm:text-xs text-slate-400 uppercase tracking-wide font-bold">Tỷ lệ</span>
                    </div>
                </div>

                <button onclick="restartQuiz()" class="w-full sm:w-auto bg-slate-600 hover:bg-slate-500 text-white font-bold py-3.5 px-10 rounded-xl transition transform active:scale-95 shadow-lg flex items-center justify-center border-b-4 border-slate-800">
                    <i class="fas fa-redo-alt mr-2"></i> Làm lại (Đảo đề)
                </button>
            </div>
        </div>

    </div>

    <script>
        // NGÂN HÀNG CÂU HỎI (70% KHÓ - 30% DỄ)
        const questionBank = [
            // --- PHẦN 1: DỄ (WARM UP - 30%) ---
            {
                question: "The man ______ spoke to me is my teacher.",
                options: ["who", "which", "whose", "whom"],
                answer: 0,
                explanation: "Cơ bản: Người (The man) + Động từ (spoke) => Dùng 'who'."
            },
            {
                question: "This is the book ______ I bought yesterday.",
                options: ["who", "whom", "where", "which"],
                answer: 3,
                explanation: "Cơ bản: Vật (The book) + Chủ ngữ (I) => Dùng 'which'."
            },
            {
                question: "I met a girl ______ name is Lan.",
                options: ["who", "which", "whose", "whom"],
                answer: 2,
                explanation: "Cơ bản: Chỉ sở hữu (Tên CỦA cô ấy) => Dùng 'whose'."
            },
            {
                question: "Do you know the reason ______ she left?",
                options: ["where", "why", "which", "when"],
                answer: 1,
                explanation: "Cơ bản: Reason đi với Why."
            },
            {
                question: "The hotel ______ we stayed was very expensive.",
                options: ["which", "that", "where", "whom"],
                answer: 2,
                explanation: "Cơ bản: Nơi chốn + Đủ câu (we stayed) => Dùng 'where'."
            },
             {
                question: "The letter ______ arrived this morning had no stamp.",
                options: ["who", "whom", "which", "whose"],
                answer: 2,
                explanation: "Cơ bản: Vật làm chủ ngữ => Dùng 'which'."
            },
             {
                question: "This is the boy ______ I told you about.",
                options: ["which", "whose", "whom", "where"],
                answer: 2,
                explanation: "Cơ bản: Tân ngữ chỉ người => Dùng 'whom'."
            },
            {
                question: "The day ______ we met was rainy.",
                options: ["which", "where", "when", "who"],
                answer: 2,
                explanation: "Cơ bản: Thời gian => Dùng 'when'."
            },
            {
                question: "The car ______ driver is a young man is from Germany.",
                options: ["who", "whose", "which", "that"],
                answer: 1,
                explanation: "Cơ bản: Tài xế CỦA cái xe => Dùng 'whose'."
            },
            {
                question: "Mr. Pike, ______ is my neighbor, is very nice.",
                options: ["who", "that", "whom", "which"],
                answer: 0,
                explanation: "Cơ bản: Có dấu phẩy + Người làm chủ ngữ => Dùng 'who' (cấm dùng that)."
            },
            {
                question: "The computer ______ I use every day is old.",
                options: ["who", "whom", "where", "which"],
                answer: 3,
                explanation: "Cơ bản: Vật làm tân ngữ => Dùng 'which'."
            },
            {
                question: "This is the village ______ I was born.",
                options: ["which", "in where", "where", "that"],
                answer: 2,
                explanation: "Cơ bản: Nơi chốn => Dùng 'where'."
            },
             {
                question: "That's the woman to ______ I gave the money.",
                options: ["who", "whom", "that", "which"],
                answer: 1,
                explanation: "Cơ bản: Sau giới từ chỉ người bắt buộc dùng 'whom'."
            },
             {
                question: "I don't like the stories ______ have unhappy endings.",
                options: ["who", "which", "where", "whom"],
                answer: 1,
                explanation: "Cơ bản: Vật làm chủ ngữ => Dùng 'which'."
            },
            
            // --- PHẦN 2: KHÓ & NÂNG CAO (HARD CORE - 70%) ---
            
            // Dạng 1: Giới từ phức tạp
            {
                question: "The extent ______ he has improved is remarkable.",
                options: ["to which", "on which", "at which", "for which"],
                answer: 0,
                explanation: "Nâng cao: Cụm cố định 'To an extent' (đến một mức độ) => Dùng 'to which'."
            },
            {
                question: "The manner ______ she addressed the audience was impressive.",
                options: ["in which", "on which", "at which", "to which"],
                answer: 0,
                explanation: "Nâng cao: Cụm 'In a manner' (theo một cách thức) => Dùng 'in which'."
            },
            {
                question: "This is the tool ______ I fixed the car.",
                options: ["by which", "with which", "of which", "for which"],
                answer: 1,
                explanation: "Nâng cao: Chỉ công cụ (Fix WITH a tool) => Dùng 'with which'."
            },
            {
                question: "The means ______ we communicate have changed.",
                options: ["by which", "on which", "to which", "at which"],
                answer: 0,
                explanation: "Nâng cao: Cụm 'By means of' hoặc 'By a means' (bằng phương tiện/cách thức) => Dùng 'by which'."
            },
             {
                question: "The speed ______ light travels is 300,000 km/s.",
                options: ["at which", "on which", "in which", "with which"],
                answer: 0,
                explanation: "Nâng cao: Tốc độ luôn đi với AT (at a speed) => Dùng 'at which'."
            },

            // Dạng 2: What vs That vs Which
            {
                question: "______ he said was completely true.",
                options: ["That", "What", "Which", "The thing"],
                answer: 1,
                explanation: "Nâng cao: Đây là mệnh đề danh từ làm chủ ngữ. 'WHAT he said' = 'The thing that he said'. Không dùng 'Which' vì không có danh từ phía trước để bổ nghĩa."
            },
            {
                question: "Everything ______ he said was true.",
                options: ["what", "that", "which", "who"],
                answer: 1,
                explanation: "Nâng cao: Sau đại từ bất định (Everything, all, nothing...) bắt buộc dùng 'THAT'. Cấm dùng 'What'."
            },
            {
                question: "I can't give you ______ you want.",
                options: ["that", "which", "what", "where"],
                answer: 2,
                explanation: "Nâng cao: 'Cái điều mà bạn muốn' => 'What you want'. (Làm tân ngữ cho động từ give)."
            },

            // Dạng 3: Lượng từ & Sở hữu cách ngược
            {
                question: "I have three brothers, all of ______ are married.",
                options: ["who", "whom", "them", "that"],
                answer: 1,
                explanation: "Nâng cao: Sau lượng từ (all of, some of...) + Đại từ quan hệ chỉ người => Bắt buộc dùng 'whom'."
            },
            {
                question: "He asked me a lot of questions, none of ______ I could answer.",
                options: ["them", "which", "that", "what"],
                answer: 1,
                explanation: "Nâng cao: Sau lượng từ + Đại từ quan hệ chỉ vật => Bắt buộc dùng 'which'."
            },
            {
                question: "They have two sons, neither of ______ goes to university.",
                options: ["who", "whom", "them", "which"],
                answer: 1,
                explanation: "Nâng cao: Neither of whom (Không ai trong số họ)."
            },
             {
                question: "He sat on a chair, the legs ______ were broken.",
                options: ["of which", "of whom", "whose", "which"],
                answer: 0,
                explanation: "Nâng cao: Sở hữu cách của vật có 2 dạng: 'Whose legs' hoặc 'The legs OF WHICH'. Ở đây có 'the legs' sẵn rồi nên chọn 'of which'."
            },

            // Dạng 4: Rút gọn & Câu chẻ (Cleft sentences)
            {
                question: "The man ______ in the accident was taken to hospital.",
                options: ["injuring", "injured", "to injure", "injure"],
                answer: 1,
                explanation: "Nâng cao: Rút gọn mệnh đề bị động (The man WHO WAS INJURED) => injured."
            },
            {
                question: "The experiment ______ at the University of Oxford was successful.",
                options: ["conducted", "conducting", "to conduct", "conduct"],
                answer: 0,
                explanation: "Nâng cao: Rút gọn bị động: 'Thí nghiệm ĐƯỢC thực hiện' => conducted."
            },
            {
                question: "It was Tom ______ helped us.",
                options: ["which", "that", "whom", "what"],
                answer: 1,
                explanation: "Nâng cao: Câu chẻ (It was ... that ...). Dùng để nhấn mạnh. Dù là người (Tom) nhưng cấu trúc chuẩn là dùng 'that' (hoặc who). Ở đây 'that' là đáp án tốt nhất trong cấu trúc nhấn mạnh."
            },
            {
                question: "It was in Paris ______ we met.",
                options: ["where", "that", "which", "when"],
                answer: 1,
                explanation: "Nâng cao: Câu chẻ nhấn mạnh trạng ngữ 'It was [Place] THAT...'. Rất dễ nhầm thành 'where'. Nếu dùng Where thì nghĩa là 'Nó ở Paris, nơi mà chúng ta gặp' (Câu này không nhấn mạnh). Cấu trúc It is... that bắt buộc dùng that."
            },

            // Dạng 5: Which thay thế cả câu (Connective Relative Clause)
            {
                question: "He failed the exam, ______ surprised everyone.",
                options: ["that", "what", "which", "it"],
                answer: 2,
                explanation: "Nâng cao: Dùng 'which' thay thế cho cả mệnh đề phía trước (Việc anh ta trượt thi)."
            },
            {
                question: "She didn't come, ______ was a pity.",
                options: ["what", "that", "which", "who"],
                answer: 2,
                explanation: "Nâng cao: 'Which' thay thế cho cả sự việc 'She didn't come'."
            },

            // Dạng 6: Bẫy & Logic
            {
                question: "The only student ______ I think can pass is John.",
                options: ["who", "whom", "which", "that"],
                answer: 3,
                explanation: "Nâng cao: Có 'The only' => Ưu tiên dùng 'that'. Có cụm 'I think' chen vào làm nhiễu, nhưng chủ ngữ chính vẫn là 'that' (cho động từ can pass)."
            },
            {
                question: "There is no one ______ can solve this problem.",
                options: ["who", "whom", "but", "which"],
                answer: 2,
                explanation: "Siêu khó: Cấu trúc 'There is no one BUT...' (Không có ai ngoại trừ...). Trong ngữ cảnh cổ hoặc văn học, 'but' hoạt động như một đại từ quan hệ phủ định (= who...not). Tuy nhiên, nếu đáp án có 'that/who' thì chọn that/who. Ở đây giả sử đáp án bẫy là 'but' (nghĩa: không có ai mà KHÔNG giải quyết được = ai cũng giải quyết được? Không, nghĩa là 'Không có ai, ngoại trừ người có thể...'). Thực ra câu phổ biến là 'There is no one THAT can...'. Nhưng nếu gặp 'but' thì 'There is no one but knows' = 'Everyone knows'. Câu này đáp án 'who' vẫn đúng nhất. Nhưng để thử thách, ta chọn câu: 'There is no rule ______ has exceptions.' -> đáp án 'but' (= that does not have). Với câu trên, đáp án an toàn là 'who', nhưng nếu muốn 'hack não', hãy nhớ cấu trúc 'but' sau phủ định."
            },
            // Sửa lại câu trên cho chuẩn mực hơn để tránh tranh cãi:
            {
                question: "The road ______ we are driving is very bumpy.",
                options: ["on which", "at which", "in which", "to which"],
                answer: 0,
                explanation: "Nâng cao: Drive ON a road => Dùng 'on which'."
            },

            {
                question: "Anyone ______ in the topic can join the club.",
                options: ["interested", "interesting", "interest", "to interest"],
                answer: 0,
                explanation: "Nâng cao: Rút gọn tính từ (Anyone WHO IS INTERESTED) => interested."
            },
            {
                question: "We need a room ______ 100 people.",
                options: ["holding", "held", "to hold", "holds"],
                answer: 2,
                explanation: "Nâng cao: Rút gọn chỉ mục đích/khả năng (A room TO HOLD - phòng để chứa) hoặc rút gọn chủ động (holding). Tuy nhiên với nghĩa 'để chứa', 'to hold' thường được dùng sau danh từ chỉ vật chứa đựng khi nói về sức chứa thiết kế. Nhưng 'holding' cũng đúng (phòng cái mà đang chứa). Trong ngữ cảnh 'cần tìm phòng', dùng 'to hold' (mục đích) chính xác hơn."
            },
            {
                question: "Is there anything ______ I can do for you?",
                options: ["what", "which", "that", "who"],
                answer: 2,
                explanation: "Nâng cao: Sau đại từ bất định 'anything' => Dùng 'that'."
            },
            {
                question: "______ enters the room must sign in.",
                options: ["Who", "Whoever", "Whom", "Whomever"],
                answer: 1,
                explanation: "Nâng cao: 'Bất cứ ai' làm chủ ngữ => 'Whoever'. 'Who' cũng được nhưng 'Whoever' nhấn mạnh tính bất định tốt hơn."
            },
            {
                question: "We came to a path, the end ______ led to a river.",
                options: ["of which", "whose", "of whom", "which"],
                answer: 0,
                explanation: "Nâng cao: Sở hữu cách vật + cụm danh từ có 'the' (the end) => Dùng 'of which'."
            },
            {
                question: "He is the person ______ I believe is the best candidate.",
                options: ["whom", "who", "which", "whose"],
                answer: 1,
                explanation: "Nâng cao (Bẫy): Rất nhiều người chọn 'whom' vì thấy 'I believe'. Nhưng thực ra 'I believe' chỉ là mệnh đề chêm. Cấu trúc chính là: 'He is the person [WHO] is the best candidate'. 'Who' làm chủ ngữ cho 'is', không phải tân ngữ của 'believe'."
            },
            {
                question: "The movie ______ we went to see was boring.",
                options: ["which", "to which", "where", "what"],
                answer: 0,
                explanation: "Nâng cao: See a movie (Tân ngữ). Giới từ 'to' thuộc về 'went to see', không phải của movie. => Dùng 'which'."
            },
            {
                question: "Physics, ______ is my favorite subject, is difficult.",
                options: ["that", "what", "which", "who"],
                answer: 2,
                explanation: "Nâng cao: Dấu phẩy + Vật => Dùng 'which'."
            },
            {
                question: "The reason ______ he refused is unknown.",
                options: ["why", "for which", "that", "All are correct"],
                answer: 3,
                explanation: "Nâng cao: Sau 'The reason', ta có thể dùng 'why', 'for which', hoặc 'that' (trong văn nói), hoặc thậm chí lược bỏ. Đáp án 'All are correct' là chuẩn nhất."
            },
            {
                question: "Whatever ______ to him, he never gives up.",
                options: ["happens", "happen", "happening", "to happen"],
                answer: 0,
                explanation: "Nâng cao: Mệnh đề danh từ/trạng ngữ. Whatever (số ít) + V(s/es) => happens."
            },
            {
                question: "The bed ______ I slept was uncomfortable.",
                options: ["in which", "on which", "at which", "which"],
                answer: 0,
                explanation: "Nâng cao: Sleep IN a bed (nằm trong chăn đệm) phổ biến hơn Sleep ON a bed (nằm trên bề mặt). Tuy nhiên ON cũng chấp nhận được. Nhưng chuẩn ngữ pháp SGK thường là 'in a bed'. Chọn 'in which'."
            },
            {
                question: "My boss, for ______ I have worked for 20 years, is retiring.",
                options: ["who", "that", "whom", "whose"],
                answer: 2,
                explanation: "Nâng cao: Giới từ 'for' + Người => Bắt buộc 'whom'."
            },
            {
                question: "The flight ______ we wanted to travel was fully booked.",
                options: ["on which", "in which", "at which", "by which"],
                answer: 0,
                explanation: "Nâng cao: Travel ON a flight => 'on which'."
            },
            {
                question: "The goals ______ he is aiming are unrealistic.",
                options: ["at which", "for which", "to which", "on which"],
                answer: 0,
                explanation: "Nâng cao: Aim AT (nhắm tới) => 'at which'."
            },
            {
                question: "The agreement ______ we signed is valid.",
                options: ["which", "to which", "on which", "in which"],
                answer: 0,
                explanation: "Nâng cao: Sign an agreement (Ký hợp đồng - Tân ngữ trực tiếp) => Dùng 'which'. Không cần giới từ."
            },
            {
                question: "The agreement ______ we agreed was not signed.",
                options: ["on which", "at which", "to which", "in which"],
                answer: 0,
                explanation: "Nâng cao: Agree ON something (Đồng ý về cái gì) => 'on which'."
            },
            {
                question: "The crisis ______ we are facing is serious.",
                options: ["which", "where", "in which", "at which"],
                answer: 0,
                explanation: "Nâng cao: Face a crisis (Đối mặt khủng hoảng - Tân ngữ trực tiếp) => Dùng 'which'."
            },
            {
                question: "The family ______ I stayed was very kind.",
                options: ["with whom", "with which", "at whom", "to whom"],
                answer: 0,
                explanation: "Nâng cao: Stay WITH a family (Ở cùng gia đình - Người) => 'with whom'."
            },
             {
                question: "Look at the picture ______ Tom is standing.",
                options: ["in which", "on which", "at which", "to which"],
                answer: 0,
                explanation: "Nâng cao: Trong bức tranh (không gian 2D/3D mô phỏng) dùng IN. 'In the picture'."
            },
            {
                question: "Tell me ______ you want me to do.",
                options: ["that", "which", "what", "why"],
                answer: 2,
                explanation: "Nâng cao: 'Cái điều mà bạn muốn...' => 'What'."
            },
             {
                question: "The playground ______ we played was sandy.",
                options: ["on which", "in which", "at which", "to which"],
                answer: 0,
                explanation: "Nâng cao: Play ON a playground => 'on which'."
            }
        ];

        let questions = []; 
        let currentQuestion = 0;
        let score = 0;
        let isAnswered = false;

        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const resultScreen = document.getElementById('result-screen');
        const progressBar = document.getElementById('progress-bar');
        const explanationBox = document.getElementById('explanation-box');
        const nextBtnContainer = document.getElementById('next-btn-container');

        // Hàm xáo trộn mảng (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startQuiz() {
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            
            score = 0;
            currentQuestion = 0;
            questions = [...questionBank]; 
            shuffleArray(questions); 
            
            loadQuestion();
        }

        function loadQuestion() {
            isAnswered = false;
            const q = questions[currentQuestion];
            
            // Update UI elements
            document.getElementById('question-counter').innerText = `Câu ${currentQuestion + 1}/${questions.length}`;
            document.getElementById('question-text').innerText = q.question;
            document.getElementById('score-display').innerText = `Điểm: ${score}`;
            
            explanationBox.classList.add('hidden');
            nextBtnContainer.classList.add('hidden');

            const progress = ((currentQuestion) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;

            const optionsHtml = q.options.map((opt, index) => `
                <div onclick="checkAnswer(${index}, this)" 
                     class="option-item border-2 border-slate-600 rounded-xl p-4 cursor-pointer hover:bg-slate-700 hover:border-rose-500 transition flex items-center group bg-slate-800 shadow-sm active:bg-slate-900 touch-manipulation">
                    <div class="w-8 h-8 rounded-full border-2 border-slate-500 mr-4 flex-shrink-0 flex items-center justify-center group-hover:border-rose-400 font-bold text-slate-400 text-sm">
                        ${String.fromCharCode(65 + index)}
                    </div>
                    <span class="text-slate-200 font-medium text-base sm:text-lg">${opt}</span>
                </div>
            `).join('');
            
            document.getElementById('options-container').innerHTML = optionsHtml;
        }

        function checkAnswer(selectedIndex, element) {
            if (isAnswered) return;
            isAnswered = true;

            const q = questions[currentQuestion];
            const options = document.querySelectorAll('.option-item');

            document.getElementById('explanation-text').innerHTML = q.explanation;
            explanationBox.classList.remove('hidden');
            nextBtnContainer.classList.remove('hidden');

            if (window.innerWidth < 640) {
                setTimeout(() => {
                    explanationBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }

            if (selectedIndex === q.answer) {
                score++;
                element.classList.add('correct-anim');
                element.classList.remove('border-slate-600', 'hover:bg-slate-700');
                element.querySelector('div').classList.add('bg-emerald-600', 'text-white', 'border-transparent');
                element.innerHTML += '<i class="fas fa-check text-white ml-auto text-xl"></i>';
            } else {
                element.classList.add('wrong-anim');
                element.classList.remove('border-slate-600', 'hover:bg-slate-700');
                element.querySelector('div').classList.add('bg-rose-600', 'text-white', 'border-transparent');
                element.innerHTML += '<i class="fas fa-times text-white ml-auto text-xl"></i>';
                
                const correctOption = options[q.answer];
                correctOption.classList.add('bg-emerald-900/50', 'border-emerald-500');
                correctOption.querySelector('div').classList.add('bg-emerald-600', 'text-white', 'border-transparent');
                correctOption.innerHTML += '<i class="fas fa-check text-emerald-400 ml-auto text-xl"></i>';
            }
            
            document.getElementById('score-display').innerText = `Điểm: ${score}`;
        }

        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < questions.length) {
                loadQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            quizContainer.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            progressBar.style.width = '100%';

            const percentage = Math.round((score / questions.length) * 100);
            document.getElementById('final-score').innerText = `${score}/${questions.length}`;
            document.getElementById('final-percent').innerText = `${percentage}%`;

            const iconEl = document.getElementById('result-icon');
            const titleEl = document.getElementById('result-title');
            const msgEl = document.getElementById('result-message');

            if (percentage === 100) {
                iconEl.innerHTML = '<i class="fas fa-crown text-amber-400 animate-bounce"></i>';
                titleEl.innerText = "GODLIKE! ĐỈNH CAO!";
                msgEl.innerText = "Bạn đã chinh phục hoàn toàn thử thách siêu khó này.";
            } else if (percentage >= 80) {
                iconEl.innerHTML = '<i class="fas fa-star text-rose-400"></i>';
                titleEl.innerText = "Xuất sắc!";
                msgEl.innerText = "Kiến thức ngữ pháp của bạn ở trình độ rất cao.";
            } else if (percentage >= 50) {
                iconEl.innerHTML = '<i class="fas fa-check-circle text-emerald-400"></i>';
                titleEl.innerText = "Đã hoàn thành!";
                msgEl.innerText = "Bạn đã vượt qua các câu dễ, nhưng cần ôn thêm phần nâng cao.";
            } else {
                iconEl.innerHTML = '<i class="fas fa-book-dead text-slate-500"></i>';
                titleEl.innerText = "Đừng bỏ cuộc!";
                msgEl.innerText = "Đề này rất khó. Hãy xem kỹ phần giải thích để rút kinh nghiệm.";
            }
        }

        function restartQuiz() {
            startQuiz();
        }
    </script>
</body>
</html>