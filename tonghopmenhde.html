<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master English Clauses - 100 Tricky Questions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .option-card:hover { transform: translateY(-2px); }
        .correct-answer { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46 !important; }
        .wrong-answer { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-600"><i class="fas fa-book-open mr-2"></i>ROAD TO THPT</h1>
            <div id="progress-container" class="hidden flex items-center gap-3">
                <span class="text-sm font-medium text-gray-500">Câu <span id="current-q-num">1</span>/50</span>
                <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-indigo-600 transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-3xl">
        
        <!-- Start Screen -->
        <div id="start-screen" class="bg-white rounded-2xl shadow-lg p-8 text-center fade-in">
            <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-graduation-cap text-3xl text-indigo-600"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4">Mệnh đề Tiếng Anh</h2>
            <p class="text-gray-600 mb-8 leading-relaxed">
                Ngân hàng câu hỏi gồm <b>100 câu</b> chuyên sâu về các loại mệnh đề.<br><br>
                Hệ thống sẽ chọn ngẫu nhiên <b>50 câu</b> cho mỗi lượt thi.
            </p>
            <button onclick="startQuiz()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl transition duration-200 shadow-md transform active:scale-95">
                Bắt đầu làm bài
            </button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden fade-in">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <div class="mb-6">
                    <span class="inline-block bg-indigo-50 text-indigo-700 text-xs px-2 py-1 rounded-md font-semibold mb-2 uppercase tracking-wide">Question</span>
                    <h3 id="question-text" class="text-xl font-medium text-gray-900 leading-relaxed">
                        <!-- Question goes here -->
                    </h3>
                </div>

                <div id="options-container" class="space-y-3">
                    <!-- Options go here -->
                </div>

                <!-- Immediate Explanation Box (New Feature) -->
                <div id="explanation-container" class="hidden mt-6 p-5 bg-blue-50 text-blue-900 rounded-xl border border-blue-200 fade-in shadow-sm">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-1">
                            <i class="fas fa-lightbulb text-yellow-500 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-bold text-blue-800 uppercase tracking-wide mb-1">Giải thích chi tiết</h4>
                            <p id="explanation-text" class="text-base leading-relaxed text-gray-800 font-medium"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="next-btn" onclick="nextQuestion()" class="hidden bg-gray-900 hover:bg-gray-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 flex items-center">
                    Câu tiếp theo <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="finish-btn" onclick="finishQuiz()" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 flex items-center">
                    Nộp bài <i class="fas fa-check ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden fade-in">
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center mb-8">
                <div class="mb-4">
                    <span class="text-gray-500 text-lg">Kết quả của bạn</span>
                </div>
                <div class="text-5xl font-bold text-indigo-600 mb-2">
                    <span id="score">0</span><span class="text-2xl text-gray-400">/50</span>
                </div>
                <p id="feedback-text" class="text-gray-600 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button onclick="location.reload()" class="bg-white border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50 font-bold py-2 px-6 rounded-lg transition duration-200">
                        Làm lại đề mới
                    </button>
                    <button onclick="showReview()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-md">
                        Xem chi tiết đáp án
                    </button>
                </div>
            </div>
        </div>

        <!-- Review Section -->
        <div id="review-section" class="hidden space-y-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4 px-2">Chi tiết câu trả lời:</h3>
            <div id="review-list" class="space-y-4">
                <!-- Review items go here -->
            </div>
            <div class="text-center mt-8 pb-8">
                 <button onclick="location.reload()" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-xl hover:bg-gray-900">Làm lại đề mới</button>
            </div>
        </div>

    </main>

    <script>
        // Database of 100 Questions covering various Clause types
        // 0: A, 1: B, 2: C, 3: D
        const questionBank = [
            // --- RELATIVE CLAUSES (BASIC & PREPOSITIONS) ---
            { q: "The man _______ I spoke yesterday is my teacher.", options: ["who", "whom", "to whom", "that"], correct: 2, explain: "Cần giới từ 'to' đi kèm với động từ 'speak'. 'The man to whom I spoke' = 'The man who/whom/that I spoke to'." },
            { q: "This is the village in _______ my family has lived for 20 years.", options: ["which", "that", "where", "when"], correct: 0, explain: "Sau giới từ (in) chỉ được dùng 'which' hoặc 'whom'. Không dùng 'that' hoặc 'where' (vì where = in which, không dùng in where)." },
            { q: "He is the only student _______ solved the problem.", options: ["which", "who", "whom", "that"], correct: 3, explain: "Khi danh từ đứng trước có từ chỉ duy nhất/so sánh nhất (the only, the first, the best...), ưu tiên dùng 'that' hơn 'who'." },
            { q: "My mother, _______ everyone looks up to, is a doctor.", options: ["who", "whom", "that", "whose"], correct: 1, explain: "Mệnh đề quan hệ không xác định (có dấu phẩy), đóng vai trò tân ngữ (mọi người kính trọng MẸ TÔI) -> dùng 'whom' (trang trọng) hoặc 'who'. Ở đây 'whom' chính xác nhất về ngữ pháp chuẩn." },
            { q: "The woman _______ car was stolen reported it to the police.", options: ["who", "whom", "which", "whose"], correct: 3, explain: "Chỉ sự sở hữu (xe của người phụ nữ) -> dùng 'whose'." },
            { q: "I passed the exam, _______ surprised everyone.", options: ["that", "what", "which", "it"], correct: 2, explain: "Dùng 'which' để thay thế cho cả mệnh đề phía trước (việc tôi đỗ kỳ thi)." },
            { q: "The reason _______ he left is still a mystery.", options: ["why", "which", "for that", "on which"], correct: 0, explain: "'The reason why' = 'The reason for which'. Chỉ lý do." },
            { q: "Do you know the girl _______ to Tom?", options: ["who is talking", "talking", "talked", "A & B"], correct: 3, explain: "Mệnh đề quan hệ rút gọn chủ động. 'The girl who is talking' -> 'The girl talking'." },
            { q: "The book _______ by JK Rowling is very famous.", options: ["wrote", "written", "writing", "which wrote"], correct: 1, explain: "Mệnh đề quan hệ rút gọn bị động. 'The book which was written' -> 'The book written'." },
            { q: "There are four letters, one of _______ is from my father.", options: ["whom", "them", "which", "that"], correct: 2, explain: "Sau lượng từ (one of, all of, some of...) + mệnh đề quan hệ -> dùng 'whom' (người) hoặc 'which' (vật). Letters là vật -> 'which'." },
            
            // --- NOUN CLAUSES ---
            { q: "_______ he will come or not is uncertain.", options: ["If", "Whether", "That", "What"], correct: 1, explain: "Mệnh đề danh ngữ làm chủ ngữ có 'or not' -> bắt buộc dùng 'Whether', không dùng 'If'." },
            { q: "I don't know _______ to do next.", options: ["what", "that", "which", "how"], correct: 0, explain: "Rút gọn mệnh đề danh ngữ: Wh-word + to V. 'What to do' (làm gì)." },
            { q: "The truth is _______ he didn't study at all.", options: ["what", "that", "which", "why"], correct: 1, explain: "Mệnh đề danh ngữ đóng vai trò bổ ngữ sau tobe -> dùng 'that' để giải thích sự thật là gì." },
            { q: "_______ you did helped us a lot.", options: ["That", "Which", "What", "How"], correct: 2, explain: "Mệnh đề danh ngữ làm chủ ngữ. 'What you did' = 'The thing that you did' (Những gì bạn đã làm)." },
            { q: "We are worried about _______ we can finish the project on time.", options: ["that", "if", "whether", "what"], correct: 2, explain: "Sau giới từ (about) phải dùng 'whether', không dùng 'if' hoặc 'that'." },

            // --- REDUCED CLAUSES & TRICKY ---
            { q: "_______ from a distance, the painting looks like a photograph.", options: ["Seeing", "Seen", "To see", "Having seen"], correct: 1, explain: "Rút gọn mệnh đề trạng ngữ bị động (cùng chủ ngữ là the painting). 'When it is seen' -> 'Seen'." },
            { q: "_______ all his money, he had to go home.", options: ["Spending", "Spent", "Having spent", "To spend"], correct: 2, explain: "Hành động tiêu hết tiền xảy ra TRƯỚC hành động đi về -> Dùng Phân từ hoàn thành (Having V3)." },
            { q: "The last person _______ the room must turn off the lights.", options: ["leave", "leaving", "to leave", "left"], correct: 2, explain: "Rút gọn sau số thứ tự (the last, the first...) dùng 'to V'." },
            { q: "Not only _______ the exam, but he also got the scholarship.", options: ["he passed", "did he pass", "he did pass", "passed he"], correct: 1, explain: "Đảo ngữ với 'Not only' đứng đầu câu: Not only + Aux + S + V." },
            { q: "It was in 1990 _______ I was born.", options: ["when", "which", "that", "where"], correct: 2, explain: "Câu chẻ (Cleft sentence) nhấn mạnh trạng ngữ thời gian: It was... THAT..." },

            // --- MORE MIXED QUESTIONS (21-50) ---
            { q: "Neither the director nor his assistants _______ yet.", options: ["have arrived", "has arrived", "arriving", "is arriving"], correct: 0, explain: "Sự hòa hợp chủ ngữ: Neither... nor... chia theo chủ ngữ gần động từ nhất (assistants - số nhiều)." },
            { q: "Whatever _______, stay calm.", options: ["happens", "happen", "happening", "will happen"], correct: 0, explain: "Mệnh đề trạng ngữ. Whatever happens (Chủ ngữ là Whatever - số ít)." },
            { q: "Strange _______ it may sound, I don't like ice cream.", options: ["although", "as", "though", "even if"], correct: 1, explain: "Đảo ngữ với tính từ: Adj + as/though + S + V (Mặc dù...)." },
            { q: "Had I known you were in town, I _______ you.", options: ["would visit", "will visit", "would have visited", "visited"], correct: 2, explain: "Đảo ngữ câu điều kiện loại 3 (Had + S + V3, S + would have V3)." },
            { q: "The man to _______ I sold my car is a doctor.", options: ["who", "whom", "that", "which"], correct: 1, explain: "Sau giới từ chỉ người bắt buộc dùng 'whom'." },
            { q: "I wish I _______ to the party last night.", options: ["went", "have gone", "had gone", "go"], correct: 2, explain: "Câu ước cho quá khứ (last night) -> dùng Quá khứ hoàn thành." },
            { q: "It is essential that every student _______ the rules.", options: ["follow", "follows", "followed", "following"], correct: 0, explain: "Bàng thái cách (Subjunctive): It is essential that + S + (should) + V_inf." },
            { q: "_______ it rains, we will cancel the trip.", options: ["Unless", "If", "Providing", "Had"], correct: 1, explain: "Nếu trời mưa... (If)." },
            { q: "My father, _______ is 60, likes gardening.", options: ["that", "who", "whom", "whose"], correct: 1, explain: "Mệnh đề không xác định chỉ người -> dùng Who (chủ ngữ)." },
            { q: "He asked me _______ I liked pop music.", options: ["weather", "if", "that", "did"], correct: 1, explain: "Câu tường thuật câu hỏi Yes/No -> dùng If/Whether." },
            { q: "_______ hard he tried, he couldn't lift the rock.", options: ["Although", "However", "Whatever", "But"], correct: 1, explain: "Cấu trúc: However + adj/adv + S + V (Dù ... đến đâu)." },
            { q: "The city _______ I was born is beautiful.", options: ["which", "that", "where", "in where"], correct: 2, explain: "Nơi chốn -> dùng Where (= in which)." },
            { q: "This is the best film _______ I have ever seen.", options: ["who", "what", "where", "that"], correct: 3, explain: "So sánh nhất (the best) -> ưu tiên dùng 'that'." },
            { q: "_______ she is rich, she isn't happy.", options: ["Because", "Despite", "Although", "In spite of"], correct: 2, explain: "Mệnh đề nhượng bộ: Although + S + V." },
            { q: "The boy _______ eyes are blue is my cousin.", options: ["who", "whom", "which", "whose"], correct: 3, explain: "Sở hữu cách (mắt của cậu bé) -> Whose." },
            { q: "The decision _______ to allow students to use phones caused a debate.", options: ["make", "made", "making", "to make"], correct: 1, explain: "Mệnh đề rút gọn bị động: The decision (which was) made..." },
            { q: "We are looking forward _______ from you.", options: ["to hear", "hear", "to hearing", "hearing"], correct: 2, explain: "Cấu trúc: look forward to + Ving." },
            { q: "It was not until midnight _______ he came home.", options: ["when", "that", "which", "then"], correct: 1, explain: "Cấu trúc nhấn mạnh: It was not until... that..." },
            { q: "Only by studying hard _______ pass the exam.", options: ["you can", "can you", "you will", "did you"], correct: 1, explain: "Đảo ngữ với 'Only by + Ving' + Aux + S + V." },
            { q: "_______, he would have succeeded.", options: ["Did he try", "Had he tried", "If he tried", "Trying"], correct: 1, explain: "Đảo ngữ điều kiện loại 3: Had + S + V3." },

            // --- GROUP 3 (51-75) ---
            { q: "The song _______ we listened last night was boring.", options: ["to which", "which", "to that", "where"], correct: 0, explain: "Listen TO something -> Đảo giới từ lên trước: To which." },
            { q: "Give it to _______ needs it.", options: ["whoever", "whomever", "who", "whom"], correct: 0, explain: "Mệnh đề danh ngữ làm tân ngữ cho 'to'. Tuy nhiên, trong mệnh đề này 'needs' cần chủ ngữ -> Whoever." },
            { q: "Is that the girl _______ brother is a singer?", options: ["who", "whom", "whose", "which"], correct: 2, explain: "Sở hữu cách -> Whose." },
            { q: "I'll give you a call _______ I arrive.", options: ["while", "as soon as", "until", "during"], correct: 1, explain: "Ngay khi (As soon as)." },
            { q: "The fence _______ the house is made of wood.", options: ["surround", "surrounded", "surrounding", "surrounds"], correct: 2, explain: "Rút gọn chủ động: The fence (which surrounds) -> surrounding." },
            { q: "Anything _______ you say can be used against you.", options: ["what", "who", "whom", "that"], correct: 3, explain: "Sau đại từ bất định (anything, something, all...) dùng 'that'." },
            { q: "The reason _______ he failed is his laziness.", options: ["why", "for", "which", "because"], correct: 0, explain: "The reason why." },
            { q: "Do you agree with _______ I just said?", options: ["that", "which", "what", "who"], correct: 2, explain: "Mệnh đề danh ngữ làm tân ngữ. 'What' = the thing that." },
            { q: "It is high time we _______ home.", options: ["go", "went", "have gone", "will go"], correct: 1, explain: "It is high time + S + V_past (Đã đến lúc ai đó phải làm gì)." },
            { q: "He talked as if he _______ everything.", options: ["knows", "knew", "has known", "knowing"], correct: 1, explain: "As if + lùi thì (giả định không thật). Hiện tại lùi về quá khứ." },
            { q: "_______ she had a map, she got lost.", options: ["However", "Despite", "Although", "Because"], correct: 2, explain: "Although + Clause." },
            { q: "On the table _______ a big vase.", options: ["stand", "standing", "stands", "stood"], correct: 2, explain: "Đảo ngữ toàn bộ với cụm giới từ chỉ nơi chốn: Prep + V + S." },
            { q: "Hardly had I arrived _______ the phone rang.", options: ["than", "when", "then", "after"], correct: 1, explain: "Hardly... when... (Vừa mới... thì...)." },
            { q: "No sooner had he left _______ it started to rain.", options: ["than", "when", "then", "before"], correct: 0, explain: "No sooner... than..." },
            { q: "The students, all of _______ passed, were happy.", options: ["who", "whom", "which", "them"], correct: 1, explain: "All of + whom (người)." },
            { q: "There is no point _______ him to come.", options: ["ask", "to ask", "asking", "asked"], correct: 2, explain: "There is no point + Ving." },
            { q: "Would you mind _______ the door?", options: ["close", "to close", "closing", "closed"], correct: 2, explain: "Would you mind + Ving." },
            { q: "He suggests that we _______ to the cinema.", options: ["go", "went", "going", "to go"], correct: 0, explain: "Suggest that + S + (should) + V_inf." },
            { q: "The building _______ now is a new school.", options: ["being built", "building", "built", "to build"], correct: 0, explain: "Rút gọn bị động tiếp diễn: Which is being built -> Being built." },
            { q: "Most of the goods _______ in this factory are for export.", options: ["make", "making", "made", "to make"], correct: 2, explain: "Rút gọn bị động: Made." },
            { q: "_______, he wouldn't have met her.", options: ["If he went", "Had he not gone", "Unless he went", "Did he go"], correct: 1, explain: "Điều kiện loại 3 đảo ngữ phủ định: Had + S + not + V3." },
            { q: "It was the most boring speech _______ I have ever heard.", options: ["which", "who", "that", "what"], correct: 2, explain: "So sánh nhất -> That." },
            { q: "_______ comes first will be served first.", options: ["Whoever", "Who", "Whomever", "Anyone"], correct: 0, explain: "Mệnh đề danh ngữ làm chủ ngữ: Whoever (bất cứ ai)." },
            { q: "I can't imagine _______ anywhere else.", options: ["live", "to live", "living", "lived"], correct: 2, explain: "Imagine + Ving." },
            { q: "The doctor _______ I see is very famous.", options: ["which", "whom", "whose", "what"], correct: 1, explain: "See whom (tân ngữ chỉ người)." },

             // --- GROUP 4 (76-100) ---
            { q: "In spite of _______ tired, he finished the work.", options: ["he was", "being", "was", "is"], correct: 1, explain: "In spite of + Ving/Noun." },
            { q: "He walked quietly _______ wake the baby up.", options: ["so as not to", "in order not", "so that not", "to not"], correct: 0, explain: "So as not to V = In order not to V." },
            { q: "I will wait here _______ you come back.", options: ["until", "during", "for", "by"], correct: 0, explain: "Until + Clause." },
            { q: "_______ difficult the test is, I will try my best.", options: ["Although", "Whatever", "However", "Even if"], correct: 2, explain: "However + adj + S + V." },
            { q: "Don't forget the date _______ we first met.", options: ["which", "where", "on which", "at which"], correct: 2, explain: "Ngày tháng -> On which (= when)." },
            { q: "This is the house _______ my father built.", options: ["where", "that", "in which", "who"], correct: 1, explain: "Lưu ý: 'Build' cần tân ngữ trực tiếp (Build cái gì). House là tân ngữ -> Dùng which/that. KHÔNG dùng Where vì Where = In/At which (chỉ nơi chốn trạng ngữ)." },
            { q: "I like the car _______.", options: ["near the tree standing", "standing near the tree", "stood near the tree", "stands near the tree"], correct: 1, explain: "Rút gọn: The car (which is) standing..." },
            { q: "Are you the one _______ sent me the email?", options: ["who", "whom", "which", "whose"], correct: 0, explain: "Chủ ngữ chỉ người -> Who." },
            { q: "Everything _______ happened was my fault.", options: ["what", "that", "which", "who"], correct: 1, explain: "Sau Everything -> dùng That." },
            { q: "Tell me _______ you want.", options: ["that", "which", "what", "why"], correct: 2, explain: "Mệnh đề danh ngữ: What you want." },
            { q: "He is the man _______ opinion I respect most.", options: ["who", "whom", "whose", "that"], correct: 2, explain: "Ý kiến CỦA người đó -> Whose." },
            { q: "_______ I known the truth, I would have told you.", options: ["If", "Have", "Had", "Did"], correct: 2, explain: "Đảo ngữ loại 3." },
            { q: "Never _______ such a beautiful sight.", options: ["I have seen", "have I seen", "did I see", "saw I"], correct: 1, explain: "Đảo ngữ với Never: Never + Aux + S + V. (Hiện tại hoàn thành)." },
            { q: "Only when you grow up _______ understand.", options: ["you will", "will you", "do you", "you can"], correct: 1, explain: "Only when + Clause + Aux + S + V." },
            { q: "The woman _______ son is my friend is nice.", options: ["who", "whom", "which", "whose"], correct: 3, explain: "Whose son." },
            { q: "She is the singer _______ I am a big fan.", options: ["of who", "of whom", "whom", "who"], correct: 1, explain: "Fan OF someone -> Of whom." },
            { q: "We visited the school _______ my father used to teach.", options: ["which", "that", "where", "when"], correct: 2, explain: "Teach AT the school -> Nơi chốn -> Where." },
            { q: "He failed the exam, _______ made his parents sad.", options: ["that", "what", "which", "it"], correct: 2, explain: "Which thay thế cả mệnh đề trước." },
            { q: "The questions _______ by the teacher were difficult.", options: ["asking", "asked", "ask", "to ask"], correct: 1, explain: "Rút gọn bị động: Asked." },
            { q: "Anyone _______ in the job should apply now.", options: ["interested", "interesting", "interest", "to interest"], correct: 0, explain: "Rút gọn bị động: (Who is) interested." },
            { q: "She left without _______ goodbye.", options: ["say", "saying", "said", "to say"], correct: 1, explain: "Without + Ving." },
            { q: "We saw the thief _______ by the police.", options: ["chase", "chasing", "chased", "to chase"], correct: 2, explain: "Thấy ai đó BỊ đuổi -> Chased." },
            { q: "The laptop _______ cover is red is mine.", options: ["who", "whom", "whose", "which"], correct: 2, explain: "Sở hữu vật -> Whose." },
            { q: "There are people _______ think money is everything.", options: ["which", "who", "whom", "whose"], correct: 1, explain: "Chủ ngữ chỉ người -> Who." },
            { q: "Do you know the reason _______ she cried?", options: ["why", "which", "what", "how"], correct: 0, explain: "The reason why." }
        ];

        // --- GAME LOGIC ---
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let userAnswers = [];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz() {
            // Pick random 50 questions
            const shuffled = shuffleArray([...questionBank]);
            currentQuestions = shuffled.slice(0, 50);
            
            currentIndex = 0;
            score = 0;
            userAnswers = new Array(50).fill(null);

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('review-section').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('finish-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden'); // Hide next button initially

            renderQuestion();
        }

        function renderQuestion() {
            const q = currentQuestions[currentIndex];
            document.getElementById('current-q-num').innerText = currentIndex + 1;
            document.getElementById('progress-bar').style.width = `${((currentIndex) / 50) * 100}%`;
            
            // Hide explanation for new question
            document.getElementById('explanation-container').classList.add('hidden');

            document.getElementById('question-text').innerText = q.q;
            
            const optionsHtml = q.options.map((opt, idx) => `
                <div onclick="selectOption(${idx})" id="opt-${idx}" 
                     class="option-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:bg-indigo-50 hover:border-indigo-300 transition duration-200 flex items-center">
                    <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 font-bold flex items-center justify-center mr-3 border border-gray-300">
                        ${String.fromCharCode(65 + idx)}
                    </div>
                    <span class="text-lg text-gray-700">${opt}</span>
                </div>
            `).join('');

            document.getElementById('options-container').innerHTML = optionsHtml;

            // Reset buttons
            document.getElementById('next-btn').classList.add('hidden');
            if (currentIndex === 49) {
                 // Last question
            }
        }

        function selectOption(selectedIdx) {
            // Prevent re-selecting
            if (userAnswers[currentIndex] !== null) return;

            const currentQ = currentQuestions[currentIndex];
            userAnswers[currentIndex] = selectedIdx;

            // Visual feedback
            const correctIdx = currentQ.correct;
            const selectedEl = document.getElementById(`opt-${selectedIdx}`);
            const correctEl = document.getElementById(`opt-${correctIdx}`);

            if (selectedIdx === correctIdx) {
                score++;
                selectedEl.classList.add('correct-answer');
                // Add icon
                selectedEl.querySelector('div').innerHTML = '<i class="fas fa-check text-green-600"></i>';
                selectedEl.querySelector('div').classList.add('bg-green-100', 'border-green-300');
            } else {
                selectedEl.classList.add('wrong-answer');
                selectedEl.querySelector('div').innerHTML = '<i class="fas fa-times text-red-600"></i>';
                selectedEl.querySelector('div').classList.add('bg-red-100', 'border-red-300');
                
                // Show correct answer
                correctEl.classList.add('correct-answer');
                correctEl.querySelector('div').innerHTML = '<i class="fas fa-check text-green-600"></i>';
            }

            // Disable all clicks
            for(let i=0; i<4; i++) {
                document.getElementById(`opt-${i}`).onclick = null;
                document.getElementById(`opt-${i}`).classList.remove('cursor-pointer', 'hover:bg-indigo-50');
            }

            // SHOW EXPLANATION IMMEDIATELY
            const explainBox = document.getElementById('explanation-container');
            document.getElementById('explanation-text').innerText = currentQ.explain;
            explainBox.classList.remove('hidden');

            // Auto scroll to explanation on mobile if needed
            if (window.innerWidth < 768) {
                setTimeout(() => {
                    explainBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }

            // Show Next or Finish button
            if (currentIndex < 49) {
                document.getElementById('next-btn').classList.remove('hidden');
            } else {
                document.getElementById('finish-btn').classList.remove('hidden');
            }
        }

        function nextQuestion() {
            currentIndex++;
            renderQuestion();
        }

        function finishQuiz() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            document.getElementById('score').innerText = score;
            
            let feedback = "";
            if (score >= 45) feedback = "Xuất sắc! Bạn nắm rất vững kiến thức về Mệnh đề.";
            else if (score >= 35) feedback = "Làm tốt lắm! Bạn đã hiểu hầu hết các quy tắc quan trọng.";
            else if (score >= 20) feedback = "Khá ổn. Tuy nhiên hãy xem lại phần giải thích các câu sai nhé.";
            else feedback = "Cần cố gắng hơn. Hãy ôn lại kỹ ngữ pháp về Mệnh đề quan hệ và Danh ngữ.";
            
            document.getElementById('feedback-text').innerText = feedback;
        }

        function showReview() {
            document.getElementById('review-section').classList.remove('hidden');
            const list = document.getElementById('review-list');
            list.innerHTML = "";

            currentQuestions.forEach((q, idx) => {
                const userAns = userAnswers[idx];
                const isCorrect = userAns === q.correct;
                const userAnsText = userAns !== null ? q.options[userAns] : "Không trả lời";
                const correctAnsText = q.options[q.correct];

                const html = `
                    <div class="bg-white rounded-xl border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'} shadow-sm p-4">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-gray-500 text-sm">Câu ${idx + 1}</span>
                            ${isCorrect 
                                ? '<span class="text-green-600 font-bold text-sm"><i class="fas fa-check"></i> Đúng</span>' 
                                : '<span class="text-red-600 font-bold text-sm"><i class="fas fa-times"></i> Sai</span>'}
                        </div>
                        <p class="text-gray-800 font-medium mb-3">${q.q}</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm mb-3">
                            <div class="${isCorrect ? 'text-green-700' : 'text-red-700'}">
                                <span class="font-semibold">Bạn chọn:</span> ${userAnsText}
                            </div>
                            <div class="text-green-700">
                                <span class="font-semibold">Đáp án đúng:</span> ${correctAnsText}
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 border border-gray-100">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                            <span class="font-semibold">Giải thích:</span> ${q.explain}
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
            
            // Scroll to review section
            document.getElementById('review-section').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>